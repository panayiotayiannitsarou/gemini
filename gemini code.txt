import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math # Î˜Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„Î¿ÏÎ¼Îµ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ceil (Î¿ÏÎ¿Ï†Î®)

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ (Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ¬ ÏƒÎ±Ï‚, Î¼Îµ Ï€Î¹Î¸Î±Î½Î­Ï‚ Î²ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹Ï‚)
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    # Î•Î¾Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ· ÏŒÏ„Î¹ Î¿Î¹ Ï„Î¹Î¼Î­Ï‚ ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ­Ï‚ ÎºÎ±Î¹ Ï‡ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ NaN
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    # Î•Î¾Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ· ÏŒÏ„Î¹ Î¿Î¹ Ï„Î¹Î¼Î­Ï‚ ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ­Ï‚ ÎºÎ±Î¹ Ï‡ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ NaN
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

# Î•Î½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± ÎºÏÎ±Ï„Î¬ÎµÎ¹ ÎºÎ±Î¹ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬
def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    # Î•ÏÏÎµÏƒÎ· Ï„Î·Ï‚ Î³ÏÎ±Î¼Î¼Î®Ï‚ Ï„Î¿Ï… Î¼Î±Î¸Î·Ï„Î®
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· DataFrame
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    # Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼Î±Î¸Î·Ï„Î® ÏƒÏ„Î¿ Î»ÎµÎ¾Î¹ÎºÏŒ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½
    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats() # Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·
    
    student_row = df_students.loc[idx] # Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÏƒÎµÎ¹ÏÎ¬ Ï„Î¿Ï… Î¼Î±Î¸Î·Ï„Î®

    # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï€Î»Î®Î¸Î¿Ï…Ï‚
    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½
    # Î›Î¯ÏƒÏ„Î± Î¼Îµ Ï„Î± Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ Ï€Î¿Ï… Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ¼Îµ (ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Î¦Î™Î›Î™Î‘, Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—, ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ, Î¤ÎœÎ—ÎœÎ‘, ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£)
    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î': # Î“Î¹Î± Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î/ÎŸ
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1


# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Ï‰Î½ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

# ÎÎ­Î± Î²Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î¿Î½ Î­Î»ÎµÎ³Ï‡Î¿ Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚
def can_place(df_students, student_name, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # 1. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ (Î½Î± Î¼Î·Î½ Ï…Ï€ÎµÏÎ²Î±Î¯Î½ÎµÎ¹ Ï„Î¿ max_students_per_class)
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # 2. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (Î´Î¹Î±Ï†Î¿ÏÎ¬ Ï„Î¿ Ï€Î¿Î»Ï 1 Î±Ï€ÏŒ Ï„Î± Î¬Î»Î»Î± Ï„Î¼Î®Î¼Î±Ï„Î±)
    # Î ÏÎ¿ÏƒÎ¿Ï‡Î®: Î‘Ï…Ï„ÏŒÏ‚ Î¿ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ Ï€Î¿Î»ÏÏ€Î»Î¿ÎºÎ¿Ï‚ ÏƒÎµ Î­Î½Î± greedy Î±Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿.
    # Î˜Î± Ï„Î¿ ÎµÏ†Î±ÏÎ¼ÏŒÏƒÎ¿Ï…Î¼Îµ Ï‰Ï‚ soft constraint ÏƒÏ„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î® Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚,
    # Î±Î»Î»Î¬ ÎµÎ´Ï Ï‰Ï‚ hard constraint Î³Î¹Î± Î½Î± Î¼Î·Î½ Î¾ÎµÏ†ÏÎ³ÎµÎ¹ Ï…Ï€ÎµÏÎ²Î¿Î»Î¹ÎºÎ¬.
    
    # Î¥Ï€Î¿Î¸ÎµÏ„Î¹ÎºÏŒ Ï€Î»Î®Î¸Î¿Ï‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    min_count = min(hypothetical_counts.values())
    max_count = max(hypothetical_counts.values())

    if max_count - min_count > 1:
        # Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ Î½Î± Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹ Î±Î½ Ï„Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿ ÎºÎ±Î¹ ÎµÎ¯Î½Î±Î¹ Î¿ Ï€ÏÏÏ„Î¿Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚
        # Î® Î±Î½ Ï„Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿ Î±Ï€ÏŒ Î¬Î»Î»Î±
        if class_stats_dict[target_class_name]['count'] == 0 and len(all_class_names) > 0: # Î•Î¯Î½Î±Î¹ Î¿ Ï€ÏÏÏ„Î¿Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
             pass # Î•Î´Ï Î´ÎµÎ½ Î¹ÏƒÏ‡ÏÎµÎ¹ Î¿ ÎºÎ±Î½ÏŒÎ½Î±Ï‚ <=1
        elif hypothetical_counts[target_class_name] > min_count + 1 and max_count > min_count + 1:
            # Î‘Î½ Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï… Î¼Î±Î¸Î·Ï„Î® ÎºÎ¬Î½ÎµÎ¹ Ï„Î· Î´Î¹Î±Ï†Î¿ÏÎ¬ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ· Î±Ï€ÏŒ 1 ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î±Î³ÎºÎ±Î¯Î¿ (Ï€Ï‡ Î¬Î»Î»Î± Ï„Î¼Î®Î¼Î±Ï„Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ±)
            # Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± heuristic, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ ÏÏÎ¸Î¼Î¹ÏƒÎ·.
            return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."
            
    # 3. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_name, placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy() # Î”Î¿Ï…Î»ÎµÏÎ¿Ï…Î¼Îµ ÏƒÎµ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ Ï„Î¿Ï… DataFrame

    # Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÏ„Î·Î»ÏÎ½ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½
    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    # 1. Î’Î®Î¼Î±: Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Î Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï - ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿Ï… Î±ÏÎ¹Î¸Î¼Î¿Ï Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None # Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î¼Îµ None Î® ÎºÎ¬Ï€Î¿Î¹Î± Î­Î½Î´ÎµÎ¹Î¾Î· ÏƒÏ†Î¬Î»Î¼Î±Ï„Î¿Ï‚

    # Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î´Î¿Î¼ÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys()) # Î›Î¯ÏƒÏ„Î± Î¼Îµ Î¿Î½ÏŒÎ¼Î±Ï„Î± Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½

    # Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î‘Ï€ÏŒ ÎµÎ´Ï ÎºÎ±Î¹ Ï€Î­ÏÎ±, Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Ï„Î± Î’Î®Î¼Î±Ï„Î± 2-8 Î¼Îµ Ï„Î· ÏƒÎµÎ¹ÏÎ¬.
    # Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï€ÏÏÏ„Î¿ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹ ÎµÎ¯Î½Î±Î¹ Î· Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î±.

    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 2 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 3 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 4: Î Î±Î¹Î´Î¹Î¬ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 4 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 5: Î¦Î¯Î»Î¿Î¹ Î Î±Î¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 5 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 6: Î¦Î¹Î»Î¹ÎºÎ­Ï‚ ÎŸÎ¼Î¬Î´ÎµÏ‚ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 6 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 7: Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚ Î§Ï‰ÏÎ¯Ï‚ Î¦Î¹Î»Î¯ÎµÏ‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 7 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 8 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹


    return df

# ----------------------------------------------------
# Î›Î¿Î¹Ï€Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ (Î¯Î´Î¹ÎµÏ‚ Î¼Îµ Î±Ï…Ï„Î­Ï‚ Ï€Î¿Ï… Ï€Î±ÏÎµÎ¯Ï‡Î±Ï„Îµ)
# ----------------------------------------------------

def create_excel_file(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ÎšÎ±Ï„Î±Î½Î¿Î¼Î®')
    return output.getvalue()

def plot_distribution(df, column, title):
    fig, ax = plt.subplots(figsize=(10, 6)) # ÎšÎ±Î»ÏÏ„ÎµÏÎ¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚
    
    # Ensure all categories are present, even if counts are 0
    # For 'Î¦Î¥Î›ÎŸ', use 'Îš' and 'Î‘'
    if column == 'Î¦Î¥Î›ÎŸ':
        categories = ['Îš', 'Î‘']
    else: # For 'Î'/'ÎŸ' columns
        categories = ['Î', 'ÎŸ']

    # Unstacking might create NaNs if a category is missing in a group
    grouped_data = df.groupby(['Î¤ÎœÎ—ÎœÎ‘', column]).size().unstack(fill_value=0)
    
    # Reindex to ensure all categories are in the plot, even if they have 0 count
    for cat in categories:
        if cat not in grouped_data.columns:
            grouped_data[cat] = 0

    # Ensure column order for consistent plotting
    grouped_data = grouped_data[categories]
    
    grouped_data.plot(kind='bar', stacked=True, ax=ax)
    
    ax.set_title(title)
    ax.set_ylabel('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎœÎ±Î¸Î·Ï„ÏÎ½')
    ax.set_xlabel('Î¤Î¼Î®Î¼Î±')
    plt.xticks(rotation=45, ha='right') # Î ÎµÏÎ¹ÏƒÏ„ÏÎ¿Ï†Î® labels
    plt.tight_layout() # Î ÏÎ¿ÏƒÎ±ÏÎ¼Î¿Î³Î® layout
    st.pyplot(fig)

# ----------------------------------------------------
# ÎšÏÏÎ¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Streamlit
# ----------------------------------------------------

# ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÎ¿Ï Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚
st.sidebar.title("ğŸ” ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚")
password = st.sidebar.text_input("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ:", type="password")
if password != "katanomi2025":
    st.warning("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.")
    st.stop()

# Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·/Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚
enable_app = st.sidebar.checkbox("âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚", value=True)
if not enable_app:
    st.info("âœ‹ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·.")
    st.stop()


st.title("ğŸ“Š Î¨Î·Ï†Î¹Î±ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")

uploaded_file = st.file_uploader("â¬†ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î±Î¸Î·Ï„ÏÎ½", type="xlsx")

df_students = None # ÎŸÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ df_students ÎµÎºÏ„ÏŒÏ‚ Ï„Î¿Ï… if Î³Î¹Î± Î½Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¬Î½Ï„Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿

if uploaded_file is not None:
    df_students = pd.read_excel(uploaded_file)
    st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    # Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„Ï‰Î½ Ï€ÏÏÏ„Ï‰Î½ Î³ÏÎ±Î¼Î¼ÏÎ½ Ï„Î¿Ï… DataFrame Î³Î¹Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
    st.subheader("Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:")
    st.dataframe(df_students.head())

    # Î•Î¹ÏƒÎ±Î³Ï‰Î³Î­Ï‚ Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î±ÏÎ¹Î¸Î¼ÏŒ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ÎºÎ±Î¹ Î¼Î­Î³Î¹ÏƒÏ„Î¿ Ï€Î»Î®Î¸Î¿Ï‚
    st.sidebar.subheader("Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    num_classes_input = st.sidebar.number_input("Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½:", min_value=1, value=3, step=1)
    max_students_per_class_input = st.sidebar.number_input("ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±:", min_value=10, max_value=30, value=25, step=1)


    if st.button("â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½"):
        # ÎšÎ»Î®ÏƒÎ· Ï„Î·Ï‚ ÎµÎ½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ ÎºÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ Î¼Îµ Ï„Î¹Ï‚ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï…Ï‚ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
        df_katanomi = Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_students.copy(), num_classes_input, max_students_per_class_input)
        if df_katanomi is not None: # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î®Ï„Î±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚
            st.session_state["df_katanomi"] = df_katanomi
            st.success("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î±Î¸Î·Ï„ÏÎ½!")
        else:
            # Î— Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î­Ï‡ÎµÎ¹ Î®Î´Î· ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÎ¹ Î¼Î®Î½Ï…Î¼Î± Î»Î¬Î¸Î¿Ï…Ï‚
            pass

# Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½ Î¼ÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Ï„Î±Î½Î¿Î¼Î® ÏƒÏ„Î¿ session_state
if "df_katanomi" in st.session_state and st.session_state["df_katanomi"] is not None:
    df_result = st.session_state["df_katanomi"]

    st.subheader("ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    st.dataframe(df_result) # Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ Î¿Î»ÏŒÎºÎ»Î·ÏÎ¿ Ï„Î¿ DataFrame Î¼Îµ Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î±

    if st.button("â¬‡ï¸ Î›Î®ÏˆÎ· Excel Î¼Îµ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®"):
        excel_bytes = create_excel_file(df_result)
        st.download_button(
            label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel",
            data=excel_bytes,
            file_name="katanomi.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    
    st.subheader("ğŸ“Š Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ df_result Î³Î¹Î± Ï„Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬
    if 'Î¤ÎœÎ—ÎœÎ‘' in df_result.columns and not df_result['Î¤ÎœÎ—ÎœÎ‘'].isnull().all():
        characteristics_for_stats = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
        
        # ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® "ÎŸ" ÏƒÎµ False ÎºÎ±Î¹ "Î" ÏƒÎµ True Î³Î¹Î± Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÏŒ sum
        df_stats = df_result.copy()
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ': # Î¤Î¿ Ï†ÏÎ»Î¿ Î­Ï‡ÎµÎ¹ 'Îš'/'Î‘', ÏŒÏ‡Î¹ 'Î'/'ÎŸ'
                df_stats[col] = df_stats[col].apply(lambda x: True if x == 'Î' else False)

        # Î•Î¹Î´Î¹ÎºÏŒÏ‚ Ï‡ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± Ï„Î¿ Î¦Î¥Î›ÎŸ
        female_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Îš'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        male_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Î‘'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)

        stats_table = pd.DataFrame({
            'Î£ÏÎ½Î¿Î»Î¿ ÎœÎ±Î¸Î·Ï„ÏÎ½': df_result.groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0),
            'ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹Î±': female_counts,
            'Î‘Î³ÏŒÏÎ¹Î±': male_counts,
        })
        
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                # Sum True (Î´Î·Î»Î±Î´Î® 'Î' Î±ÏÏ‡Î¹ÎºÎ¬)
                stats_table[f'{col} (ÎÎ±Î¹)'] = df_stats.groupby('Î¤ÎœÎ—ÎœÎ‘')[col].sum().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        
        st.dataframe(stats_table)
    else:
        st.info("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î± Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬.")

    st.subheader("ğŸ“ˆ Î¡Î±Î²Î´Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    ÎµÏ€Î¹Î»Î¿Î³Î· = st.radio("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:", ["Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬", "ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"])

    plot_columns = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤'] # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤
    plot_titles = {
        'Î¦Î¥Î›ÎŸ': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦ÏÎ»Î¿Ï…',
        'Î–Î©Î—Î¡ÎŸÎ£': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½',
        'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™Î´Î¹Î±Î¹Ï„ÎµÏÎ¿Ï„Î®Ï„Ï‰Î½',
        'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎšÎ±Î»Î®Ï‚ Î“Î½ÏÏƒÎ·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÏÎ½',
        'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½',
        'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™ÎºÎ±Î½Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ®Ï‚ ÎœÎ±Î¸Î·ÏƒÎ¹Î±ÎºÎ®Ï‚ Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±Ï‚'
    }

    if ÎµÏ€Î¹Î»Î¿Î³Î· == "Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬":
        for col in plot_columns:
            if col in df_result.columns: # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î· ÏƒÏ„Î®Î»Î·
                plot_distribution(df_result, col, plot_titles.get(col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}"))
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")
    else: # ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
        for col in plot_columns:
            if col in df_result.columns: # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î· ÏƒÏ„Î®Î»Î·
                plot_distribution(df_result, col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}")
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")

# Î”Î®Î»Ï‰ÏƒÎ· Î Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÏÎ½ Î”Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½
st.markdown("---")
st.markdown(
    """
    ğŸ“Œ **ÎÎ¿Î¼Î¹ÎºÎ® Î”Î®Î»Ï‰ÏƒÎ·**: Î— Ï‡ÏÎ®ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ ÏÎ·Ï„Î® Î³ÏÎ±Ï€Ï„Î® Î¬Î´ÎµÎ¹Î± Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿Ï, Î Î±Î½Î±Î³Î¹ÏÏ„Î±Ï‚ Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï….
    ÎŒÎ»Î± Ï„Î± Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î· Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï… Î Î±Î½Î±Î³Î¹ÏÏ„Î±. Î“Î¹Î± Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
    [yiannitsoopanayiota.katanomi@gmail.com](mailto:yiannitsoopanayiota.katanomi@gmail.com)
    """
)import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï - Î Î¹Î¿ Î±Ï…ÏƒÏ„Î·ÏÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î½Î± Î´Î¹Î±Ï„Î·ÏÎ·Î¸ÎµÎ¯ Î· Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±
    # Î¥Ï€Î¿Î¸ÎµÏ„Î¹ÎºÏŒ Ï€Î»Î®Î¸Î¿Ï‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    # Î•Î¾Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î¼Î®Î¼Î±Ï„Î± Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î±ÎºÏŒÎ¼Î± Î¬Î´ÎµÎ¹Î± Î±Ï€ÏŒ Ï„Î¿Î½ Î­Î»ÎµÎ³Ï‡Î¿ min/max Î³Î¹Î± Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎ¿Ï…Î¼Îµ Ï„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·
    non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
    
    if non_empty_counts: # ÎœÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼Î·-Î¬Î´ÎµÎ¹Î± Ï„Î¼Î®Î¼Î±Ï„Î±
        min_count_non_empty = min(non_empty_counts)
        max_count_non_empty = max(non_empty_counts)
        
        if max_count_non_empty - min_count_non_empty > 1:
            # Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ Î±Î½ Ï„Î¿ Ï„Î¼Î®Î¼Î± ÏƒÏ„Î¿ Î¿Ï€Î¿Î¯Î¿ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎ¿Ï…Î¼Îµ
            # Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ ÎºÎ±Î¹ Î· Î´Î¹Î±Ï†Î¿ÏÎ¬ Î´ÎµÎ½ Î¾ÎµÏ€ÎµÏÎ½Î¬ÎµÎ¹ Ï„Î¿ 1
            if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True) # Î‘Î½Î±ÎºÎ¬Ï„ÎµÎ¼Î± Î³Î¹Î± Ï„Ï…Ï‡Î±Î¹ÏŒÏ„Î·Ï„Î± ÏƒÏ„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î®

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 2: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½")
    teacher_children = unlocked_students_df[unlocked_students_df['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥'] == 'Î'].copy()
    
    # Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î± Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï Î±Î½Î¬ Ï„Î¼Î®Î¼Î±, Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎµÏ†Î¹ÎºÏ„ÏŒ
    current_class_idx = 0
    for idx, student_row in teacher_children.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
        
        # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ (Ï€Ï‡. Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÎµ Î»Î¯ÏƒÏ„Î± ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î® ÏƒÏ„Î¿ df)
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue # Î‘Ï…Ï„ÏŒÏ‚ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ ÏƒÎµ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Ï…Ï€Î¿-Î²Î®Î¼Î± Î® Î»ÏŒÎ³Ï‰ Ï†Î¹Î»Î¯Î±Ï‚

        # Î’ÏÎµÏ‚ Î­Î½Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Ï„Î¼Î®Î¼Î±, Î¾ÎµÎºÎ¹Î½ÏÎ½Ï„Î±Ï‚ Î±Ï€ÏŒ Ï„Î¿ current_class_idx
        start_class_idx = current_class_idx
        placed_in_step = False
        while True:
            target_class_name = all_class_names[current_class_idx]
            
            # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Ï„Î¿ Ï„Î¼Î®Î¼Î± Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï
            if class_stats[target_class_name]['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            
            current_class_idx = (current_class_idx + 1) % num_classes_input
            if current_class_idx == start_class_idx: # ÎˆÏ‡Î¿Ï…Î¼Îµ ÎºÎ¬Î½ÎµÎ¹ Î­Î½Î±Î½ Ï€Î»Î®ÏÎ· ÎºÏÎºÎ»Î¿
                break # Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¼Î®Î¼Î± Ï‡Ï‰ÏÎ¯Ï‚ Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï Î® Ï€Î»Î®ÏÎµÏ‚

        if not placed_in_step: # Î‘Î½ Î´ÎµÎ½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î±ÎºÏŒÎ¼Î±, Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Ï„Î¼Î®Î¼Î±
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
            
        # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚ Ï„Ï‰Î½ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ
        if placed_in_step:
            unlocked_students_df = unlocked_students_df[unlocked_students_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] != student_name]


    # Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï†Î¹Î»Î¯Î±Ï‚ Î¼ÎµÏ„Î±Î¾Ï Ï€Î±Î¹Î´Î¹ÏÎ½ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ ÎºÎ±Î¹ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï†ÏÎ»Î¿Ï…
    # Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÏƒÏÎ½Î¸ÎµÏ„Î¿ ÎºÎ±Î¹ Î¸Î± Î³Î¯Î½ÎµÎ¹ ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î±, ÎºÎ±Î¸ÏÏ‚ Ï€ÏÎ¿Ï‹Ï€Î¿Î¸Î­Ï„ÎµÎ¹ Î¶ÎµÏ…Î³Î±ÏÏÎ¼Î±Ï„Î±/Ï„ÏÎ¹Î¬Î´ÎµÏ‚
    # Î“Î¹Î± Ï„ÏÏÎ±, Î±Ï€Î»Î¬ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ¼Îµ Î¼ÎµÎ¼Î¿Î½Ï‰Î¼Î­Î½Î± Ï„Î± Ï€Î±Î¹Î´Î¹Î¬ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½.
    # Î— Î»Î¿Î³Î¹ÎºÎ® Î³Î¹Î± "Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±Î¼Î¿Î¹Î²Î±Î¯Î± Ï†Î¹Î»Î¯Î± Î¼Îµ Î¬Î»Î»Î¿ Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï, Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ½Ï„Î±Î¹ Î¼Î±Î¶Î¯ Î¼ÏŒÎ½Î¿ Î±Î½ Î¿ ÏƒÏ…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï€Î±Î¹Î´Î¹ÏÎ½ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ ÎµÎ¯Î½Î±Î¹ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿Ï‚ Î±Ï€ÏŒ Ï„Î¿Î½ Î±ÏÎ¹Î¸Î¼ÏŒ Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½."
    # ÎºÎ±Î¹ "Î ÏÎ¿Ï„Î¹Î¼Î¬Ï„Î±Î¹ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï†ÏÎ»Î¿Ï…" Î¸Î± Î±Î½Ï„Î¹Î¼ÎµÏ„Ï‰Ï€Î¹ÏƒÏ„ÎµÎ¯ ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Ï†Î¬ÏƒÎ· Ï„Î¿Ï… Î±Î»Î³Î¿ÏÎ¯Î¸Î¼Î¿Ï…, Î¯ÏƒÏ‰Ï‚ ÏƒÏ„Î¿ Î’Î®Î¼Î± 5 Î® ÏƒÎµ ÎµÎ¹Î´Î¹ÎºÏŒ helper.


    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 3 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 4: Î Î±Î¹Î´Î¹Î¬ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 4 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 5: Î¦Î¯Î»Î¿Î¹ Î Î±Î¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 5 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 6: Î¦Î¹Î»Î¹ÎºÎ­Ï‚ ÎŸÎ¼Î¬Î´ÎµÏ‚ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 6 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 7: Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚ Î§Ï‰ÏÎ¯Ï‚ Î¦Î¹Î»Î¯ÎµÏ‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 7 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 8 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹


    return df

# ----------------------------------------------------
# Î›Î¿Î¹Ï€Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def create_excel_file(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ÎšÎ±Ï„Î±Î½Î¿Î¼Î®')
    return output.getvalue()

def plot_distribution(df, column, title):
    fig, ax = plt.subplots(figsize=(10, 6))
    
    if column == 'Î¦Î¥Î›ÎŸ':
        categories = ['Îš', 'Î‘']
    else:
        categories = ['Î', 'ÎŸ']

    grouped_data = df.groupby(['Î¤ÎœÎ—ÎœÎ‘', column]).size().unstack(fill_value=0)
    
    for cat in categories:
        if cat not in grouped_data.columns:
            grouped_data[cat] = 0

    grouped_data = grouped_data[categories]
    
    grouped_data.plot(kind='bar', stacked=True, ax=ax)
    
    ax.set_title(title)
    ax.set_ylabel('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎœÎ±Î¸Î·Ï„ÏÎ½')
    ax.set_xlabel('Î¤Î¼Î®Î¼Î±')
    plt.xticks(rotation=45, ha='right')
    plt.tight_layout()
    st.pyplot(fig)

# ----------------------------------------------------
# ÎšÏÏÎ¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Streamlit
# ----------------------------------------------------

st.sidebar.title("ğŸ” ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚")
password = st.sidebar.text_input("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ:", type="password")
if password != "katanomi2025":
    st.warning("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.")
    st.stop()

enable_app = st.sidebar.checkbox("âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚", value=True)
if not enable_app:
    st.info("âœ‹ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·.")
    st.stop()

st.title("ğŸ“Š Î¨Î·Ï†Î¹Î±ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")

uploaded_file = st.file_uploader("â¬†ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î±Î¸Î·Ï„ÏÎ½", type="xlsx")

df_students = None

if uploaded_file is not None:
    df_students = pd.read_excel(uploaded_file)
    st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    st.subheader("Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:")
    st.dataframe(df_students.head())

    st.sidebar.subheader("Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    num_classes_input = st.sidebar.number_input("Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½:", min_value=1, value=3, step=1)
    max_students_per_class_input = st.sidebar.number_input("ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±:", min_value=10, max_value=30, value=25, step=1)

    if st.button("â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½"):
        df_katanomi = Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_students.copy(), num_classes_input, max_students_per_class_input)
        if df_katanomi is not None:
            st.session_state["df_katanomi"] = df_katanomi
            st.success("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î±Î¸Î·Ï„ÏÎ½!")
        else:
            pass

if "df_katanomi" in st.session_state and st.session_state["df_katanomi"] is not None:
    df_result = st.session_state["df_katanomi"]

    st.subheader("ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    st.dataframe(df_result)

    if st.button("â¬‡ï¸ Î›Î®ÏˆÎ· Excel Î¼Îµ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®"):
        excel_bytes = create_excel_file(df_result)
        st.download_button(
            label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel",
            data=excel_bytes,
            file_name="katanomi.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    
    st.subheader("ğŸ“Š Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    if 'Î¤ÎœÎ—ÎœÎ‘' in df_result.columns and not df_result['Î¤ÎœÎ—ÎœÎ‘'].isnull().all():
        characteristics_for_stats = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
        
        df_stats = df_result.copy()
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                df_stats[col] = df_stats[col].apply(lambda x: True if x == 'Î' else False)

        female_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Îš'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        male_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Î‘'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)

        stats_table = pd.DataFrame({
            'Î£ÏÎ½Î¿Î»Î¿ ÎœÎ±Î¸Î·Ï„ÏÎ½': df_result.groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0),
            'ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹Î±': female_counts,
            'Î‘Î³ÏŒÏÎ¹Î±': male_counts,
        })
        
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                stats_table[f'{col} (ÎÎ±Î¹)'] = df_stats.groupby('Î¤ÎœÎ—ÎœÎ‘')[col].sum().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        
        st.dataframe(stats_table)
    else:
        st.info("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î± Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬.")

    st.subheader("ğŸ“ˆ Î¡Î±Î²Î´Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    ÎµÏ€Î¹Î»Î¿Î³Î· = st.radio("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:", ["Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬", "ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"])

    plot_columns = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    plot_titles = {
        'Î¦Î¥Î›ÎŸ': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦ÏÎ»Î¿Ï…',
        'Î–Î©Î—Î¡ÎŸÎ£': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½',
        'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™Î´Î¹Î±Î¹Ï„ÎµÏÎ¿Ï„Î®Ï„Ï‰Î½',
        'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎšÎ±Î»Î®Ï‚ Î“Î½ÏÏƒÎ·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÏÎ½',
        'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½',
        'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™ÎºÎ±Î½Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ®Ï‚ ÎœÎ±Î¸Î·ÏƒÎ¹Î±ÎºÎ®Ï‚ Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±Ï‚'
    }

    if ÎµÏ€Î¹Î»Î¿Î³Î· == "Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬":
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, plot_titles.get(col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}"))
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")
    else:
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}")
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")

st.markdown("---")
st.markdown(
    """
    ğŸ“Œ **ÎÎ¿Î¼Î¹ÎºÎ® Î”Î®Î»Ï‰ÏƒÎ·**: Î— Ï‡ÏÎ®ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ ÏÎ·Ï„Î® Î³ÏÎ±Ï€Ï„Î® Î¬Î´ÎµÎ¹Î± Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿Ï, Î Î±Î½Î±Î³Î¹ÏÏ„Î±Ï‚ Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï….
    ÎŒÎ»Î± Ï„Î± Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î· Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï… Î Î±Î½Î±Î³Î¹ÏÏ„Î±. Î“Î¹Î± Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
    [yiannitsoopanayiota.katanomi@gmail.com](mailto:yiannitsoopanayiota.katanomi@gmail.com)
    """
)import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï - Î Î¹Î¿ Î±Ï…ÏƒÏ„Î·ÏÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î½Î± Î´Î¹Î±Ï„Î·ÏÎ·Î¸ÎµÎ¯ Î· Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
    
    if non_empty_counts:
        min_count_non_empty = min(non_empty_counts)
        max_count_non_empty = max(non_empty_counts)
        
        if max_count_non_empty - min_count_non_empty > 1:
            if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±.
    # Î‘Î½Î±ÎºÎ±Ï„ÎµÏÎ¿Ï…Î¼Îµ Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÏÎ³Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï€ÏÎ¿ÎºÎ±Ï„Î¬Î»Î·ÏˆÎ· Î±Ï€ÏŒ Ï„Î· ÏƒÎµÎ¹ÏÎ¬ Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï….
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 2: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½")
    teacher_children_to_place = unlocked_students_df[unlocked_students_df['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥'] == 'Î'].copy()
    
    # Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î± Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï Î±Î½Î¬ Ï„Î¼Î®Î¼Î±, Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎµÏ†Î¹ÎºÏ„ÏŒ
    current_class_idx = 0
    for idx, student_row in teacher_children_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
        
        # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        # Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î± Ï‡Ï‰ÏÎ¯Ï‚ Î¬Î»Î»Î¿ Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï
        for _ in range(num_classes_input): # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ ÏŒÎ»Î± Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î±
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        # Î‘Î½ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¼Î®Î¼Î± Ï‡Ï‰ÏÎ¯Ï‚ Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï, Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ¼Îµ ÏƒÏ„Î¿ Ï€ÏÏÏ„Î¿ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿
        if not placed_in_step:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
            
        if placed_in_step:
            # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ ÏƒÏ„Î¿Î½ Î±ÏÏ‡Î¹ÎºÏŒ DataFrame
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· unlocked_students_df Î¼ÎµÏ„Î¬ Ï„Î¿ Î’Î®Î¼Î± 2
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    st.subheader("Î’Î®Î¼Î± 3: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½")
    lively_students_to_place = unlocked_students_df[unlocked_students_df['Î–Î©Î—Î¡ÎŸÎ£'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in lively_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ (Ï€Ï‡. Î±Î½ Î®Ï„Î±Î½ Ï€Î±Î¹Î´Î¯ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï)
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        # Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î± Î¼Îµ Ï„Î¹Ï‚ Î»Î¹Î³ÏŒÏ„ÎµÏÎµÏ‚ "Î–Ï‰Î·ÏÎ¿ÏÏ‚"
        min_lively_count = float('inf')
        best_class_for_lively = None

        # Î’ÏÎµÏ‚ Ï„Î¿ Ï„Î¼Î®Î¼Î± Î¼Îµ Ï„Î¿Ï…Ï‚ Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î¶Ï‰Î·ÏÎ¿ÏÏ‚ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            
            if is_valid:
                lively_count_in_class = class_stats[target_class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                if lively_count_in_class < min_lively_count:
                    min_lively_count = lively_count_in_class
                    best_class_for_lively = target_class_name
            current_class_idx = (current_class_idx + 1) % num_classes_input
        
        if best_class_for_lively:
            Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_lively, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
            st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {best_class_for_lively}.")
            placed_in_step = True
        else: # Î‘Î½ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î¿ Ï„Î¼Î®Î¼Î± Î²Î¬ÏƒÎµÎ¹ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±Ï‚, Î²ÏÎµÏ‚ Ï„Î¿ Ï€ÏÏÏ„Î¿ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
        
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· unlocked_students_df Î¼ÎµÏ„Î¬ Ï„Î¿ Î’Î®Î¼Î± 3
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 4: Î Î±Î¹import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
    
    if non_empty_counts:
        min_count_non_empty = min(non_empty_counts)
        max_count_non_empty = max(non_empty_counts)
        
        if max_count_non_empty - min_count_non_empty > 1:
            if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±.
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)

    # -----import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
    
    if non_empty_counts:
        min_count_non_empty = min(non_empty_counts)
        max_count_non_empty = max(non_empty_counts)
        
        if max_count_non_empty - min_count_non_empty > 1:
            if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±.
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 2: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½")
    teacher_children_to_place = unlocked_students_df[unlocked_students_df['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in teacher_children_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
        
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        if not placed_in_step:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
            
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    st.subheader("Î’Î®Î¼Î± 3: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½")
    lively_students_to_place = unlocked_students_df[unlocked_students_df['Î–Î©Î—Î¡ÎŸÎ£'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in lively_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        min_lively_count = float('inf')
        best_class_for_lively = None

        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            
            if is_valid:
                lively_count_in_class = class_stats[target_class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                if lively_count_in_class < min_lively_count:
                    min_lively_count = lively_count_in_class
                    best_class_for_lively = target_class_name
            current_class_idx = (current_class_idx + 1) % num_classes_input
        
        if best_class_for_lively:
            Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_lively, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
            st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {best_class_for_lively}.")
            placed_in_step = True
        else:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
        
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î® 4: Î Î±Î¹Î´Î¹Î¬ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ -----
    st.subheader("Î’Î®Î¼Î± 4: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚")
    special_needs_students_to_place = unlocked_students_df[unlocked_students_df['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in special_needs_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        # Î ÏÏÏ„Î· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: ÎˆÎ½Î±Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î¼Îµ Î¹Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± Î±Î½Î¬ Ï„Î¼Î®Î¼Î±
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        # Î”ÎµÏÏ„ÎµÏÎ· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹, Î¿Î¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½:
        if not placed_in_step:
            min_lively_in_class = float('inf') # Î“Î¹Î± Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï„Î¼Î®Î¼Î± Î¼Îµ Ï„Î¿Ï…Ï‚ Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î¶Ï‰Î·ÏÎ¿ÏÏ‚
            best_class_for_special = None
            
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    current_lively_in_class = class_stats[class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                    if current_lively_in_class < min_lively_in_class:
                        min_lively_in_class = current_lively_in_class
                        best_class_for_special = class_name
            
            if best_class_for_special:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_special, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± - Î•Ï€Î¹Ï€Î»Î­Î¿Î½) ÏƒÏ„Î¿ {best_class_for_special}.")
                placed_in_step = True
            else:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")

        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 5: Î¦Î¯Î»Î¿Î¹ Î Î±Î¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ -----
    st.subheader("Î’Î®Î¼Î± 5: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¯Î»Ï‰Î½ Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Ï‰Î½ Î Î±Î¹Î´Î¹ÏÎ½")

    # Î ÎµÏÎ½Î¬Î¼Îµ Î±Ï€ÏŒ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ Ï€Î¿Ï… Î”Î•Î Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î±ÎºÏŒÎ¼Î±
    # ÎºÎ±Î¹ ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î­Ï‡Î¿Ï…Î½ Ï†Î¹Î»Î¯Î± Î¼Îµ ÎºÎ¬Ï€Î¿Î¹Î¿Î½ Ï€Î¿Ï… Î•Î§Î•Î™ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯.
    
    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Î¼Î¹Î± Î»Î¯ÏƒÏ„Î± Î¼Îµ Ï„Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿Î¹
    locked_students_names = df[df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == True]['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].tolist()

    # Î•Ï€Î±Î½Î±Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ Ï†Î¯Î»Ï‰Î½ Î¼Î­Ï‡ÏÎ¹ Î½Î± Î¼Î·Î½ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î³Î¯Î½Î¿Ï…Î½ Î¬Î»Î»ÎµÏ‚ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÎ¹Ï‚
    # (Î³Î¹Î± Î½Î± ÎºÎ±Î»ÏÏˆÎ¿Ï…Î¼Îµ Î±Î»Ï…ÏƒÎ¯Î´ÎµÏ‚ Ï†Î¹Î»Î¯Î±Ï‚)
    made_placement = True
    while made_placement:
        made_placement = False
        unlocked_students_to_check = df[(df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == False)].copy().sample(frac=1, random_state=42) # Î‘Î½Î±ÎºÎ¬Ï„ÎµÎ¼Î± Î³Î¹Î± Ï„Ï…Ï‡Î±Î¹ÏŒÏ„Î·Ï„Î±
        
        for idx, student_row in unlocked_students_to_check.iterrows():
            student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
            
            # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î¾Î±Î½Î¬ Î¼Î®Ï€Ï‰Ï‚ ÎºÎ»ÎµÎ¹Î´ÏÎ¸Î·ÎºÎµ ÏƒÎµ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î²ÏÏŒÏ‡Î¿
            if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
                continue

            friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
            friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]

            for friend_name in friends_list:
                if friend_name in locked_students_names: # ÎŸ Ï†Î¯Î»Î¿Ï‚ Î­Ï‡ÎµÎ¹ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯
                    # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î¼Î¿Î¹Î²Î±Î¯Î± Ï†Î¹Î»Î¯Î±
                    if is_mutual_friend(df, student_name, friend_name):
                        friend_class = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name, 'Î¤ÎœÎ—ÎœÎ‘'].iloc[0]
                        
                        if friend_class is not None: # ÎŸ Ï†Î¯Î»Î¿Ï‚ Î­Ï‡ÎµÎ¹ Ï„Î¼Î®Î¼Î±
                            is_valid, msg = can_place(df, student_row, friend_class, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                            if is_valid:
                                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, friend_class, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' Î¼Îµ Ï„Î¿Î½/Ï„Î·Î½ Ï†Î¯Î»Î¿/Î· '{friend_name}' ÏƒÏ„Î¿ {friend_class}.")
                                df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                                locked_students_names.append(student_name) # Î ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Ï„Î¿Î½ Î½Î­Î¿ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿
                                made_placement = True
                                break # Î ÏÎ¿Ï‡ÏÏÎ± ÏƒÏ„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î¾ÎµÎºÎ»ÎµÎ¯Î´Ï‰Ï„Î¿ Î¼Î±Î¸Î·Ï„Î®
            if made_placement: # Î‘Î½ ÎºÎ¬Î½Î±Î¼Îµ Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·, Î¾Î±Î½Î±Î¾ÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î¿Î½ Î²ÏÏŒÏ‡Î¿ while Î³Î¹Î± Î½Î± Ï€Î¹Î¬ÏƒÎ¿Ï…Î¼Îµ Ï€Î¹Î¸Î±Î½Î­Ï‚ Î½Î­ÎµÏ‚ Î±Î»Ï…ÏƒÎ¯Î´ÎµÏ‚
                break 
    
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 6: Î¦Î¹Î»Î¹ÎºÎ­Ï‚ ÎŸÎ¼Î¬Î´ÎµÏ‚ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 6 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 7: Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚ Î§Ï‰ÏÎ¯Ï‚ Î¦Î¹Î»Î¯ÎµÏ‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 7 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 8 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹


    return df

# ----------------------------------------------------
# Î›Î¿Î¹Ï€Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ (Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î¯Î´Î¹ÎµÏ‚)
# ----------------------------------------------------

def create_excel_file(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ÎšÎ±Ï„Î±Î½Î¿Î¼Î®')
    return output.getvalue()

def plot_distribution(df, column, title):
    fig, ax = plt.subplots(figsize=(10, 6))
    
    if column == 'Î¦Î¥Î›ÎŸ':
        categories = ['Îš', 'Î‘']
    else:
        categories = ['Î', 'ÎŸ']

    grouped_data = df.groupby(['Î¤ÎœÎ—ÎœÎ‘', column]).size().unstack(fill_value=0)
    
    for cat in categories:
        if cat not in grouped_data.columns:
            grouped_data[cat] = 0

    grouped_data = grouped_data[categories]
    
    grouped_data.plot(kind='bar', stacked=True, ax=ax)
    
    ax.set_title(title)
    ax.set_ylabel('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎœÎ±Î¸Î·Ï„ÏÎ½')
    ax.set_xlabel('Î¤Î¼Î®Î¼Î±')
    plt.xticks(rotation=45, ha='right')
    plt.tight_layout()
    st.pyplot(fig)

# ----------------------------------------------------
# ÎšÏÏÎ¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Streamlit (Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿)
# ----------------------------------------------------

st.sidebar.title("ğŸ” ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚")
password = st.sidebar.text_input("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ:", type="password")
if password != "katanomi2025":
    st.warning("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.")
    st.stop()

enable_app = st.sidebar.checkbox("âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚", value=True)
if not enable_app:
    st.info("âœ‹ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·.")
    st.stop()

st.title("ğŸ“Š Î¨Î·Ï†Î¹Î±ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")

uploaded_file = st.file_uploader("â¬†ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î±Î¸Î·Ï„ÏÎ½", type="xlsx")

df_students = None

if uploaded_file is not None:
    df_students = pd.read_excel(uploaded_file)
    st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    st.subheader("Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:")
    st.dataframe(df_students.head())

    st.sidebar.subheader("Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    num_classes_input = st.sidebar.number_input("Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½:", min_value=1, value=3, step=1)
    max_students_per_class_input = st.sidebar.number_input("ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±:", min_value=10, max_value=30, value=25, step=1)

    if st.button("â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½"):
        df_katanomi = Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_students.copy(), num_classes_input, max_students_per_class_input)
        if df_katanomi is not None:
            st.session_state["df_katanomi"] = df_katanomi
            st.success("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î±Î¸Î·Ï„ÏÎ½!")
        else:
            pass

if "df_katanomi" in st.session_state and st.session_state["df_katanomi"] is not None:
    df_result = st.session_state["df_katanomi"]

    st.subheader("ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    st.dataframe(df_result)

    if st.button("â¬‡ï¸ Î›Î®ÏˆÎ· Excel Î¼Îµ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®"):
        excel_bytes = create_excel_file(df_result)
        st.download_button(
            label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel",
            data=excel_bytes,
            file_name="katanomi.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    
    st.subheader("ğŸ“Š Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    if 'Î¤ÎœÎ—ÎœÎ‘' in df_result.columns and not df_result['Î¤ÎœÎ—ÎœÎ‘'].isnull().all():
        characteristics_for_stats = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
        
        df_stats = df_result.copy()
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                df_stats[col] = df_stats[col].apply(lambda x: True if x == 'Î' else False)

        female_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Îš'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        male_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Î‘'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)

        stats_table = pd.DataFrame({
            'Î£ÏÎ½Î¿Î»Î¿ ÎœÎ±Î¸Î·Ï„ÏÎ½': df_result.groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0),
            'ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹Î±': female_counts,
            'Î‘Î³ÏŒÏÎ¹Î±': male_counts,
        })
        
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                stats_table[f'{col} (ÎÎ±Î¹)'] = df_stats.groupby('Î¤ÎœÎ—ÎœÎ‘')[col].sum().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        
        st.dataframe(stats_table)
    else:
        st.info("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î± Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬.")

    st.subheader("ğŸ“ˆ Î¡Î±Î²Î´Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    ÎµÏ€Î¹Î»Î¿Î³Î· = st.radio("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:", ["Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬", "ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"])

    plot_columns = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    plot_titles = {
        'Î¦Î¥Î›ÎŸ': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦ÏÎ»Î¿Ï…',
        'Î–Î©Î—Î¡ÎŸÎ£': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½',
        'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™Î´Î¹Î±Î¹Ï„ÎµÏÎ¿Ï„Î®Ï„Ï‰Î½',
        'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎšÎ±Î»Î®Ï‚ Î“Î½ÏÏƒÎ·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÏÎ½',
        'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½',
        'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™ÎºÎ±Î½Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ®Ï‚ ÎœÎ±Î¸Î·ÏƒÎ¹Î±ÎºÎ®Ï‚ Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±Ï‚'
    }

    if ÎµÏ€Î¹Î»Î¿Î³Î· == "Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬":
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, plot_titles.get(col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}"))
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")
    else:
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}")
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")

st.markdown("---")
st.markdown(
    """
    ğŸ“Œ **ÎÎ¿Î¼Î¹ÎºÎ® Î”Î®Î»Ï‰ÏƒÎ·**: Î— Ï‡ÏÎ®ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ ÏÎ·Ï„Î® Î³ÏÎ±Ï€Ï„Î® Î¬Î´ÎµÎ¹Î± Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿Ï, Î Î±Î½Î±Î³Î¹ÏÏ„Î±Ï‚ Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï….
    ÎŒÎ»Î± Ï„Î± Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î· Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï… Î Î±Î½Î±Î³Î¹ÏÏ„Î±. Î“Î¹Î± Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
    [yiannitsoopanayiota.katanomi@gmail.com](mailto:yiannitsoopanayiota.katanomi@gmail.com)
    """
)import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_val, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
    
    if non_empty_counts:
        min_count_non_empty = min(non_empty_counts)
        max_count_non_empty = max(non_empty_counts)
        
        if max_count_non_empty - min_count_non_empty > 1:
            if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±.
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 2: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½")
    teacher_children_to_place = unlocked_students_df[unlocked_students_df['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in teacher_children_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
        
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        if not placed_in_step:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
            
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    st.subheader("Î’Î®Î¼Î± 3: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½")
    lively_students_to_place = unlocked_students_df[unlocked_students_df['Î–Î©Î—Î¡ÎŸÎ£'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in lively_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        min_lively_count = float('inf')
        best_class_for_lively = None

        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            
            if is_valid:
                lively_count_in_class = class_stats[target_class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                if lively_count_in_class < min_lively_count:
                    min_lively_count = lively_count_in_class
                    best_class_for_lively = target_class_name
            current_class_idx = (current_class_idx + 1) % num_classes_input
        
        if best_class_for_lively:
            Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_lively, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
            st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {best_class_for_lively}.")
            placed_in_step = True
        else:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
        
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 4: Î Î±Î¹Î´Î¹Î¬ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ -----
    st.subheader("Î’Î®Î¼Î± 4: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚")
    special_needs_students_to_place = unlocked_students_df[unlocked_students_df['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in special_needs_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        # Î ÏÏÏ„Î· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: ÎˆÎ½Î±Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î¼Îµ Î¹Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± Î±Î½Î¬ Ï„Î¼Î®Î¼Î±
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        # Î”ÎµÏÏ„ÎµÏÎ· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹, Î¿Î¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½:
        if not placed_in_step:
            min_lively_in_class = float('inf') # Î“Î¹Î± Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï„Î¼Î®Î¼Î± Î¼Îµ Ï„Î¿Ï…Ï‚ Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î¶Ï‰Î·ÏÎ¿ÏÏ‚
            best_class_for_special = None
            
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    current_lively_in_class = class_stats[class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                    if current_lively_in_class < min_lively_in_class:
                        min_lively_in_class = current_lively_in_class
                        best_class_for_special = class_name
            
            if best_class_for_special:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_special, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± - Î•Ï€Î¹Ï€Î»Î­Î¿Î½) ÏƒÏ„Î¿ {best_class_for_special}.")
                placed_in_step = True
            else:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")

        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 5: Î¦Î¯Î»Î¿Î¹ Î Î±Î¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ -----
    st.subheader("Î’Î®Î¼Î± 5: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¯Î»Ï‰Î½ Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Ï‰Î½ Î Î±Î¹Î´Î¹ÏÎ½")

    locked_students_names = df[df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == True]['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].tolist()

    made_placement = True
    while made_placement:
        made_placement = False
        unlocked_students_to_check = df[(df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == False)].copy().sample(frac=1, random_state=42)
        
        for idx, student_row in unlocked_students_to_check.iterrows():
            student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
            
            if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
                continue

            friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
            friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]

            for friend_name in friends_list:
                if friend_name in locked_students_names:
                    if is_mutual_friend(df, student_name, friend_name):
                        friend_class = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name, 'Î¤ÎœÎ—ÎœÎ‘'].iloc[0]
                        
                        if friend_class is not None:
                            is_valid, msg = can_place(df, student_row, friend_class, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                            if is_valid:
                                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, friend_class, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' Î¼Îµ Ï„Î¿Î½/Ï„Î·Î½ Ï†Î¯Î»Î¿/Î· '{friend_name}' ÏƒÏ„Î¿ {friend_class}.")
                                df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                                locked_students_names.append(student_name)
                                made_placement = True
                                break
            if made_placement:
                break 
    
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 6: Î¦Î¹Î»Î¹ÎºÎ­Ï‚ ÎŸÎ¼Î¬Î´ÎµÏ‚ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 6: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¹Î»Î¹ÎºÏÎ½ ÎŸÎ¼Î¬Î´Ï‰Î½ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ / Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±")
    
    # Î•Î½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚ Î¿Î¼Î¬Î´Ï‰Î½ Ï†Î¯Î»Ï‰Î½ Î³Î¹Î± ÎºÎ¬Î¸Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
    # ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î
    greek_knowledge_students = unlocked_students_df[unlocked_students_df['ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î'] == 'Î'].copy()
    
    # ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤
    satisfactory_ability_students = unlocked_students_df[unlocked_students_df['Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤'] == 'Î'].copy()

    # Î£Ï…Î½Î´Ï…Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚, Î´Î¯Î½Î¿Î½Ï„Î±Ï‚ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î± ÏƒÏ„Î·Î½ ÎºÎ±Î»Î® Î³Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½
    students_for_step_6 = pd.concat([
        greek_knowledge_students, 
        satisfactory_ability_students[~satisfactory_ability_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].isin(greek_knowledge_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'])]
    ]).sample(frac=1, random_state=42).reset_index(drop=True) # Î‘Î½Î±ÎºÎ¬Ï„ÎµÎ¼Î±

    for idx, student_row in students_for_step_6.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
        friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]
        
        # Î•Î½Ï„Î¿Ï€Î¯Î¶Î¿Ï…Î¼Îµ Î±Î¼Î¿Î¹Î²Î±Î¯Î¿Ï…Ï‚ Ï†Î¯Î»Î¿Ï…Ï‚ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿Ï…Ï‚
        mutual_unlocked_friends = []
        for friend_name in friends_list:
            friend_exists = df[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name]
            if not friend_exists.empty and friend_exists['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0] == False:
                if is_mutual_friend(df, student_name, friend_name):
                    mutual_unlocked_friends.append(friend_name)
        
        group_to_place = [student_name] + mutual_unlocked_friends
        
        # Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ Ï„Î·Ï‚ Î¿Î¼Î¬Î´Î±Ï‚
        random.shuffle(all_class_names)
        for class_name in all_class_names:
            can_place_group = True
            # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ ÏŒÎ»Î¿Î¹ Î¿Î¹ Î¼Î±Î¸Î·Ï„Î­Ï‚ Ï„Î·Ï‚ Î¿Î¼Î¬Î´Î±Ï‚ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸Î¿ÏÎ½ ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï„Î¼Î®Î¼Î±
            temp_df = df.copy() # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Î­Î½Î± Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ df Î³Î¹Î± Ï…Ï€Î¿Î¸ÎµÏ„Î¹ÎºÎ¿ÏÏ‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚
            temp_Ï„Î¼Î·Î¼Î±Ï„Î± = {k: v[:] for k, v in Ï„Î¼Î·Î¼Î±Ï„Î±.items()} # Î‘Î½Ï„Î¯Î³ÏÎ±Ï†Î¿
            temp_class_stats = {k: v.copy() for k, v in class_stats.items()} # Î‘Î½Ï„Î¯Î³ÏÎ±Ï†Î¿
            
            for member_name in group_to_place:
                member_row = temp_df.loc[temp_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == member_name].iloc[0]
                is_valid, msg = can_place(temp_df, member_row, class_name, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, max_students_per_class_input, all_class_names)
                if not is_valid:
                    can_place_group = False
                    break
                # Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿, Ï…Ï€Î¿Î¸ÎµÏ„Î¹ÎºÎ¬ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ¼Îµ Î³Î¹Î± Ï„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î­Î»ÎµÎ³Ï‡Î¿
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(temp_df, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, member_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=False) # ÎœÎ·Î½ ÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î±

            if can_place_group:
                # Î‘Î½ ÏŒÎ»Î· Î· Î¿Î¼Î¬Î´Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯, Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ­ Ï„Î¿Ï…Ï‚ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬
                for member_name in group_to_place:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, member_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{member_name}' (ÎŸÎ¼Î¬Î´Î±) ÏƒÏ„Î¿ {class_name}.")
                    df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == member_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                placed_in_step = True
                break # Î— Î¿Î¼Î¬Î´Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ, Ï€ÏÎ¿Ï‡ÏÏÎ·ÏƒÎµ ÏƒÏ„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î¼Î±Î¸Î·Ï„Î®

        if not placed_in_step:
            # Î‘Î½ Î· Î¿Î¼Î¬Î´Î± Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¶Î¯, Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿Î½ Î¼Î±Î¸Î·Ï„Î® Î¼ÏŒÎ½Î¿Ï‚ Ï„Î¿Ï…
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (ÎœÏŒÎ½Î¿Ï‚) ÏƒÏ„Î¿ {class_name}.")
                    df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                    placed_in_step = True
                    break
            if not placed_in_step:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î¿Î¼Î¬Î´Î±/Î¼ÏŒÎ½Î¿Ï‚) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")


    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 7: Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚ Î§Ï‰ÏÎ¯Ï‚ Î¦Î¹Î»Î¯ÎµÏ‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 7 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹

    # ----- Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 8 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹


    return df

# ----------------------------------------------------
# Î›Î¿Î¹Ï€Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ (Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î¯Î´Î¹ÎµÏ‚)
# ----------------------------------------------------

def create_excel_file(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ÎšÎ±Ï„Î±Î½Î¿Î¼Î®')
    return output.getvalue()

def plot_distribution(df, column, title):
    fig, ax = plt.subplots(figsize=(10, 6))
    
    if column == 'Î¦Î¥Î›ÎŸ':
        categories = ['Îš', 'Î‘']
    else:
        categories = ['Î', 'ÎŸ']

    grouped_data = df.groupby(['Î¤ÎœÎ—ÎœÎ‘', column]).size().unstack(fill_value=0)
    
    for cat in categories:
        if cat not in grouped_data.columns:
            grouped_data[cat] = 0

    grouped_data = grouped_data[categories]
    
    grouped_data.plot(kind='bar', stacked=True, ax=ax)
    
    ax.set_title(title)
    ax.set_ylabel('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎœÎ±Î¸Î·Ï„ÏÎ½')
    ax.set_xlabel('Î¤Î¼Î®Î¼Î±')
    plt.xticks(rotation=45, ha='right')
    plt.tight_layout()
    st.pyplot(fig)

# ----------------------------------------------------
# ÎšÏÏÎ¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Streamlit (Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿)
# ----------------------------------------------------

st.sidebar.title("ğŸ” ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚")
password = st.sidebar.text_input("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ:", type="password")
if password != "katanomi2025":
    st.warning("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.")
    st.stop()

enable_app = st.sidebar.checkbox("âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚", value=True)
if not enable_app:
    st.info("âœ‹ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·.")
    st.stop()

st.title("ğŸ“Š Î¨Î·Ï†Î¹Î±ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")

uploaded_file = st.file_uploader("â¬†ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î±Î¸Î·Ï„ÏÎ½", type="xlsx")

df_students = None

if uploaded_file is not None:
    df_students = pd.read_excel(uploaded_file)
    st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    st.subheader("Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:")
    st.dataframe(df_students.head())

    st.sidebar.subheader("Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    num_classes_input = st.sidebar.number_input("Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½:", min_value=1, value=3, step=1)
    max_students_per_class_input = st.sidebar.number_input("ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±:", min_value=10, max_value=30, value=25, step=1)

    if st.button("â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½"):
        df_katanomi = Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_students.copy(), num_classes_input, max_students_per_class_input)
        if df_katanomi is not None:
            st.session_state["df_katanomi"] = df_katanomi
            st.success("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î±Î¸Î·Ï„ÏÎ½!")
        else:
            pass

if "df_katanomi" in st.session_state and st.session_state["df_katanomi"] is not None:
    df_result = st.session_state["df_katanomi"]

    st.subheader("ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    st.dataframe(df_result)

    if st.button("â¬‡ï¸ Î›Î®ÏˆÎ· Excel Î¼Îµ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®"):
        excel_bytes = create_excel_file(df_result)
        st.download_button(
            label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel",
            data=excel_bytes,
            file_name="katanomi.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    
    st.subheader("ğŸ“Š Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    if 'Î¤ÎœÎ—ÎœÎ‘' in df_result.columns and not df_result['Î¤ÎœÎ—ÎœÎ‘'].isnull().all():
        characteristics_for_stats = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
        
        df_stats = df_result.copy()
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                df_stats[col] = df_stats[col].apply(lambda x: True if x == 'Î' else False)

        female_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Îš'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        male_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Î‘'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)

        stats_table = pd.DataFrame({
            'Î£ÏÎ½Î¿Î»Î¿ ÎœÎ±Î¸Î·Ï„ÏÎ½': df_result.groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0),
            'ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹Î±': female_counts,
            'Î‘Î³ÏŒÏÎ¹Î±': male_counts,
        })
        
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                stats_table[f'{col} (ÎÎ±Î¹)'] = df_stats.groupby('Î¤ÎœÎ—ÎœÎ‘')[col].sum().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        
        st.dataframe(stats_table)
    else:
        st.info("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î± Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬.")

    st.subheader("ğŸ“ˆ Î¡Î±Î²Î´Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    ÎµÏ€Î¹Î»Î¿Î³Î· = st.radio("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:", ["Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬", "ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"])

    plot_columns = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    plot_titles = {
        'Î¦Î¥Î›ÎŸ': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦ÏÎ»Î¿Ï…',
        'Î–Î©Î—Î¡ÎŸÎ£': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½',
        'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™Î´Î¹Î±Î¹Ï„ÎµÏÎ¿Ï„Î®Ï„Ï‰Î½',
        'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎšÎ±Î»Î®Ï‚ Î“Î½ÏÏƒÎ·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÏÎ½',
        'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½',
        'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™ÎºÎ±Î½Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ®Ï‚ ÎœÎ±Î¸Î·ÏƒÎ¹Î±ÎºÎ®Ï‚ Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±Ï‚'
    }

    if ÎµÏ€Î¹Î»Î¿Î³Î· == "Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬":
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, plot_titles.get(col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}"))
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")
    else:
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}")
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")

st.markdown("---")
st.markdown(
    """
    ğŸ“Œ **ÎÎ¿Î¼Î¹ÎºÎ® Î”Î®Î»Ï‰ÏƒÎ·**: Î— Ï‡ÏÎ®ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ ÏÎ·Ï„Î® Î³ÏÎ±Ï€Ï„Î® Î¬Î´ÎµÎ¹Î± Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿Ï, Î Î±Î½Î±Î³Î¹ÏÏ„Î±Ï‚ Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï….
    ÎŒÎ»Î± Ï„Î± Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î· Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï… Î Î±Î½Î±Î³Î¹ÏÏ„Î±. Î“Î¹Î± Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
    [yiannitsoopanayiota.katanomi@gmail.com](mailto:yiannitsoopanayiota.katanomi@gmail.com)
    """
)import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï
    hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
    hypothetical_counts[target_class_name] += 1
    
    non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
    
    if non_empty_counts:
        min_count_non_empty = min(non_empty_counts)
        max_count_non_empty = max(non_empty_counts)
        
        if max_count_non_empty - min_count_non_empty > 1:
            if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±.
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 2: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½")
    teacher_children_to_place = unlocked_students_df[unlocked_students_df['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in teacher_children_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
        
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        if not placed_in_step:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
            
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    st.subheader("Î’Î®Î¼Î± 3: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½")
    lively_students_to_place = unlocked_students_df[unlocked_students_df['Î–Î©Î—Î¡ÎŸÎ£'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in lively_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        min_lively_count = float('inf')
        best_class_for_lively = None

        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            
            if is_valid:
                lively_count_in_class = class_stats[target_class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                if lively_count_in_class < min_lively_count:
                    min_lively_count = lively_count_in_class
                    best_class_for_lively = target_class_name
            current_class_idx = (current_class_idx + 1) % num_classes_input
        
        if best_class_for_lively:
            Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_lively, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
            st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {best_class_for_lively}.")
            placed_in_step = True
        else:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
        
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î® 4: Î Î±Î¹Î´Î¹Î¬ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ -----
    st.subheader("Î’Î®Î¼Î± 4: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚")
    special_needs_students_to_place = unlocked_students_df[unlocked_students_df['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in special_needs_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        # Î ÏÏÏ„Î· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: ÎˆÎ½Î±Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î¼Îµ Î¹Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± Î±Î½Î¬ Ï„Î¼Î®Î¼Î±
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        # Î”ÎµÏÏ„ÎµÏÎ· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹, Î¿Î¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½:
        if not placed_in_step:
            min_lively_in_class = float('inf') # Î“Î¹Î± Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï„Î¼Î®Î¼Î± Î¼Îµ Ï„Î¿Ï…Ï‚ Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î¶Ï‰Î·ÏÎ¿ÏÏ‚
            best_class_for_special = None
            
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    current_lively_in_class = class_stats[class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                    if current_lively_in_class < min_lively_in_class:
                        min_lively_in_class = current_lively_in_class
                        best_class_for_special = class_name
            
            if best_class_for_special:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_special, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± - Î•Ï€Î¹Ï€Î»Î­Î¿Î½) ÏƒÏ„Î¿ {best_class_for_special}.")
                placed_in_step = True
            else:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")

        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 5: Î¦Î¯Î»Î¿Î¹ Î Î±Î¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ -----
    st.subheader("Î’Î®Î¼Î± 5: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¯Î»Ï‰Î½ Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Ï‰Î½ Î Î±Î¹Î´Î¹ÏÎ½")

    locked_students_names = df[df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == True]['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].tolist()

    made_placement = True
    while made_placement:
        made_placement = False
        unlocked_students_to_check = df[(df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == False)].copy().sample(frac=1, random_state=42)
        
        for idx, student_row in unlocked_students_to_check.iterrows():
            student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
            
            if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
                continue

            friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
            friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]

            for friend_name in friends_list:
                if friend_name in locked_students_names:
                    if is_mutual_friend(df, student_name, friend_name):
                        friend_class = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name, 'Î¤ÎœÎ—ÎœÎ‘'].iloc[0]
                        
                        if friend_class is not None:
                            is_valid, msg = can_place(df, student_row, friend_class, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                            if is_valid:
                                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, friend_class, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' Î¼Îµ Ï„Î¿Î½/Ï„Î·Î½ Ï†Î¯Î»Î¿/Î· '{friend_name}' ÏƒÏ„Î¿ {friend_class}.")
                                df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                                locked_students_names.append(student_name)
                                made_placement = True
                                break
            if made_placement:
                break 
    
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 6: Î¦Î¹Î»Î¹ÎºÎ­Ï‚ ÎŸÎ¼Î¬Î´ÎµÏ‚ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 6: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¹Î»Î¹ÎºÏÎ½ ÎŸÎ¼Î¬Î´Ï‰Î½ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ / Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±")
    
    greek_knowledge_students = unlocked_students_df[unlocked_students_df['ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î'] == 'Î'].copy()
    satisfactory_ability_students = unlocked_students_df[unlocked_students_df['Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤'] == 'Î'].copy()

    students_for_step_6 = pd.concat([
        greek_knowledge_students, 
        satisfactory_ability_students[~satisfactory_ability_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].isin(greek_knowledge_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'])]
    ]).sample(frac=1, random_state=42).reset_index(drop=True)

    for idx, student_row in students_for_step_6.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
        friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]
        
        mutual_unlocked_friends = []
        for friend_name in friends_list:
            friend_exists = df[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name]
            if not friend_exists.empty and friend_exists['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0] == False:
                if is_mutual_friend(df, student_name, friend_name):
                    mutual_unlocked_friends.append(friend_name)
        
        group_to_place = [student_name] + mutual_unlocked_friends
        
        random.shuffle(all_class_names)
        for class_name in all_class_names:
            can_place_group = True
            temp_df = df.copy()
            temp_Ï„Î¼Î·Î¼Î±Ï„Î± = {k: v[:] for k, v in Ï„Î¼Î·Î¼Î±Ï„Î±.items()}
            temp_class_stats = {k: v.copy() for k, v in class_stats.items()}
            
            for member_name in group_to_place:
                member_row = temp_df.loc[temp_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == member_name].iloc[0]
                is_valid, msg = can_place(temp_df, member_row, class_name, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, max_students_per_class_input, all_class_names)
                if not is_valid:
                    can_place_group = False
                    break
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(temp_df, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, member_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=False)

            if can_place_group:
                for member_name in group_to_place:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, member_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{member_name}' (ÎŸÎ¼Î¬Î´Î±) ÏƒÏ„Î¿ {class_name}.")
                    df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == member_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                placed_in_step = True
                break

        if not placed_in_step:
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (ÎœÏŒÎ½Î¿Ï‚) ÏƒÏ„Î¿ {class_name}.")
                    df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                    placed_in_step = True
                    break
            if not placed_in_step:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î¿Î¼Î¬Î´Î±/Î¼ÏŒÎ½Î¿Ï‚) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")


    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 7: Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚ Î§Ï‰ÏÎ¯Ï‚ Î¦Î¹Î»Î¯ÎµÏ‚ -----
    st.subheader("Î’Î®Î¼Î± 7: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Ï‰Î½ ÎœÎ±Î¸Î·Ï„ÏÎ½")

    for idx, student_row in unlocked_students_df.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        # Î›Î¯ÏƒÏ„Î± Î¼Îµ Ï„Î¼Î®Î¼Î±Ï„Î±, Î±Î½Î±ÎºÎ±Ï„ÎµÎ¼Î­Î½Î· Î³Î¹Î± Ï„Ï…Ï‡Î±Î¹ÏŒÏ„Î·Ï„Î± ÏƒÏ„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î®
        shuffled_class_names = all_class_names[:]
        random.shuffle(shuffled_class_names)

        # Î ÏÏÏ„Î· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: Î¤Î¼Î®Î¼Î± Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î¼Î±Î¸Î·Ï„Î­Ï‚ Î³Î¹Î± Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï
        best_class = None
        min_students = min(class_stats[cls]['count'] for cls in all_class_names)
        
        # Î’ÏÎµÏ‚ Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Ï„Î¿Î½ ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ Î±ÏÎ¹Î¸Î¼ÏŒ Î¼Î±Î¸Î·Ï„ÏÎ½
        potential_classes = [cls for cls in shuffled_class_names if class_stats[cls]['count'] == min_students]
        
        # Î‘Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½, Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Ï€ÏÏÏ„Î± Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÎ¹Ï‚ ÎµÎºÎµÎ¯
        for class_name in potential_classes:
            is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            if is_valid:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚) ÏƒÏ„Î¿ {class_name} (Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Î Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï).")
                placed_in_step = True
                break
        
        # Î‘Î½ Î´ÎµÎ½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î±ÎºÏŒÎ¼Î±, Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î­Î³ÎºÏ…ÏÎ¿ Ï„Î¼Î®Î¼Î±,
        # Î´Î¯Î½Î¿Î½Ï„Î±Ï‚ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î± ÏƒÏ„Î¿ Ï†ÏÎ»Î¿ Î³Î¹Î± Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±
        if not placed_in_step:
            gender_target_class = None
            min_gender_diff = float('inf')

            for class_name in shuffled_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    # Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î¿Î¸ÎµÏ„Î¹ÎºÎ®Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï†ÏÎ»Î¿Ï…
                    temp_male_count = class_stats[class_name]['Î¦Î¥Î›ÎŸ_Î‘']
                    temp_female_count = class_stats[class_name]['Î¦Î¥Î›ÎŸ_Îš']
                    
                    if student_row['Î¦Î¥Î›ÎŸ'] == 'Î‘':
                        temp_male_count += 1
                    else:
                        temp_female_count += 1
                    
                    current_gender_diff = abs(temp_male_count - temp_female_count)

                    if current_gender_diff < min_gender_diff:
                        min_gender_diff = current_gender_diff
                        gender_target_class = class_name
            
            if gender_target_class:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, gender_target_class, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚) ÏƒÏ„Î¿ {gender_target_class} (Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Î¦ÏÎ»Î¿Ï…).")
                placed_in_step = True
            else:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")

        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ -----
    # ÎšÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Î’Î®Î¼Î± 8 Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹


    return df

# ----------------------------------------------------
# Î›Î¿Î¹Ï€Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ (Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î¯Î´Î¹ÎµÏ‚)
# ----------------------------------------------------

def create_excel_file(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ÎšÎ±Ï„Î±Î½Î¿Î¼Î®')
    return output.getvalue()

def plot_distribution(df, column, title):
    fig, ax = plt.subplots(figsize=(10, 6))
    
    if column == 'Î¦Î¥Î›ÎŸ':
        categories = ['Îš', 'Î‘']
    else:
        categories = ['Î', 'ÎŸ']

    grouped_data = df.groupby(['Î¤ÎœÎ—ÎœÎ‘', column]).size().unstack(fill_value=0)
    
    for cat in categories:
        if cat not in grouped_data.columns:
            grouped_data[cat] = 0

    grouped_data = grouped_data[categories]
    
    grouped_data.plot(kind='bar', stacked=True, ax=ax)
    
    ax.set_title(title)
    ax.set_ylabel('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎœÎ±Î¸Î·Ï„ÏÎ½')
    ax.set_xlabel('Î¤Î¼Î®Î¼Î±')
    plt.xticks(rotation=45, ha='right')
    plt.tight_layout()
    st.pyplot(fig)

# ----------------------------------------------------
# ÎšÏÏÎ¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Streamlit (Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿)
# ----------------------------------------------------

st.sidebar.title("ğŸ” ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚")
password = st.sidebar.text_input("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ:", type="password")
if password != "katanomi2025":
    st.warning("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.")
    st.stop()

enable_app = st.sidebar.checkbox("âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚", value=True)
if not enable_app:
    st.info("âœ‹ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·.")
    st.stop()

st.title("ğŸ“Š Î¨Î·Ï†Î¹Î±ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")

uploaded_file = st.file_uploader("â¬†ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î±Î¸Î·Ï„ÏÎ½", type="xlsx")

df_students = None

if uploaded_file is not None:
    df_students = pd.read_excel(uploaded_file)
    st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    st.subheader("Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:")
    st.dataframe(df_students.head())

    st.sidebar.subheader("Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    num_classes_input = st.sidebar.number_input("Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½:", min_value=1, value=3, step=1)
    max_students_per_class_input = st.sidebar.number_input("ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±:", min_value=10, max_value=30, value=25, step=1)

    if st.button("â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½"):
        df_katanomi = Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_students.copy(), num_classes_input, max_students_per_class_input)
        if df_katanomi is not None:
            st.session_state["df_katanomi"] = df_katanomi
            st.success("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î±Î¸Î·Ï„ÏÎ½!")
        else:
            pass

if "df_katanomi" in st.session_state and st.session_state["df_katanomi"] is not None:
    df_result = st.session_state["df_katanomi"]

    st.subheader("ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    st.dataframe(df_result)

    if st.button("â¬‡ï¸ Î›Î®ÏˆÎ· Excel Î¼Îµ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®"):
        excel_bytes = create_excel_file(df_result)
        st.download_button(
            label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel",
            data=excel_bytes,
            file_name="katanomi.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    
    st.subheader("ğŸ“Š Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    if 'Î¤ÎœÎ—ÎœÎ‘' in df_result.columns and not df_result['Î¤ÎœÎ—ÎœÎ‘'].isnull().all():
        characteristics_for_stats = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
        
        df_stats = df_result.copy()
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                df_stats[col] = df_stats[col].apply(lambda x: True if x == 'Î' else False)

        female_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Îš'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        male_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Î‘'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)

        stats_table = pd.DataFrame({
            'Î£ÏÎ½Î¿Î»Î¿ ÎœÎ±Î¸Î·Ï„ÏÎ½': df_result.groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0),
            'ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹Î±': female_counts,
            'Î‘Î³ÏŒÏÎ¹Î±': male_counts,
        })
        
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                stats_table[f'{col} (ÎÎ±Î¹)'] = df_stats.groupby('Î¤ÎœÎ—ÎœÎ‘')[col].sum().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        
        st.dataframe(stats_table)
    else:
        st.info("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î± Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬.")

    st.subheader("ğŸ“ˆ Î¡Î±Î²Î´Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    ÎµÏ€Î¹Î»Î¿Î³Î· = st.radio("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:", ["Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬", "ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"])

    plot_columns = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    plot_titles = {
        'Î¦Î¥Î›ÎŸ': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦ÏÎ»Î¿Ï…',
        'Î–Î©Î—Î¡ÎŸÎ£': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½',
        'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™Î´Î¹Î±Î¹Ï„ÎµÏÎ¿Ï„Î®Ï„Ï‰Î½',
        'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎšÎ±Î»Î®Ï‚ Î“Î½ÏÏƒÎ·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÏÎ½',
        'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½',
        'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™ÎºÎ±Î½Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ®Ï‚ ÎœÎ±Î¸Î·ÏƒÎ¹Î±ÎºÎ®Ï‚ Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±Ï‚'
    }

    if ÎµÏ€Î¹Î»Î¿Î³Î· == "Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬":
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, plot_titles.get(col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}"))
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")
    else:
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}")
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")

st.markdown("---")
st.markdown(
    """
    ğŸ“Œ **ÎÎ¿Î¼Î¹ÎºÎ® Î”Î®Î»Ï‰ÏƒÎ·**: Î— Ï‡ÏÎ®ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ ÏÎ·Ï„Î® Î³ÏÎ±Ï€Ï„Î® Î¬Î´ÎµÎ¹Î± Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿Ï, Î Î±Î½Î±Î³Î¹ÏÏ„Î±Ï‚ Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï….
    ÎŒÎ»Î± Ï„Î± Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î· Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï… Î Î±Î½Î±Î³Î¹ÏÏ„Î±. Î“Î¹Î± Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
    [yiannitsoopanayiota.katanomi@gmail.com](mailto:yiannitsoopanayiota.katanomi@gmail.com)
    """
)import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import BytesIO
import random
import math

# ----------------------------------------------------
# Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚
# ----------------------------------------------------

def is_mutual_friend(df, child1_name, child2_name):
    f1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î¦Î™Î›Î™Î‘'].values
    f2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î¦Î™Î›Î™Î‘'].values

    f1 = str(f1_val[0]) if f1_val.size > 0 and pd.notna(f1_val[0]) else ""
    f2 = str(f2_val[0]) if f2_val.size > 0 and pd.notna(f2_val[0]) else ""

    friends1 = [f.strip() for f in f1.split(",") if f.strip()]
    friends2 = [f.strip() for f in f2.split(",") if f.strip()]

    return (child2_name in friends1) and (child1_name in friends2)

def has_conflict(df, child1_name, child2_name):
    c1_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child1_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values
    c2_val = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == child2_name, 'Î£Î¥Î“ÎšÎ¡ÎŸÎ¥Î£Î—'].values

    c1 = str(c1_val[0]) if c1_val.size > 0 and pd.notna(c1_val[0]) else ""
    c2 = str(c2_val[0]) if c2_val.size > 0 and pd.notna(c2_val[0]) else ""

    conflicts1 = [c.strip() for c in c1.split(",") if c.strip()]
    conflicts2 = [c.strip() for c in c2.split(",") if c.strip()]

    return (child2_name in conflicts1) or (child1_name in conflicts2)

def initialize_class_stats():
    stats = {'count': 0, 'Î¦Î¥Î›ÎŸ_Îš': 0, 'Î¦Î¥Î›ÎŸ_Î‘': 0}
    characteristics_N_O = ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    for char in characteristics_N_O:
        stats[f'{char}_Î'] = 0
    return stats

def Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df_students, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, Î¼Î±Î¸Î·Ï„Î·Ï‚_name, Ï„Î¼Î·Î¼Î±_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True):
    idx = df_students.index[df_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == Î¼Î±Î¸Î·Ï„Î·Ï‚_name].tolist()
    if not idx:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: ÎœÎ±Î¸Î·Ï„Î®Ï‚ '{Î¼Î±Î¸Î·Ï„Î·Ï‚_name}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ DataFrame.")
        return

    idx = idx[0]
    
    # Remove student from old class if already assigned
    old_class = df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘']
    if old_class and old_class in Ï„Î¼Î·Î¼Î±Ï„Î±_dict and Î¼Î±Î¸Î·Ï„Î·Ï‚_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[old_class]:
        Ï„Î¼Î·Î¼Î±Ï„Î±_dict[old_class].remove(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)
        if old_class in class_stats_dict:
            class_stats_dict[old_class]['count'] -= 1
            student_row_old = df_students.loc[idx]
            if student_row_old['Î¦Î¥Î›ÎŸ'] == 'Îš':
                class_stats_dict[old_class]['Î¦Î¥Î›ÎŸ_Îš'] -= 1
            elif student_row_old['Î¦Î¥Î›ÎŸ'] == 'Î‘':
                class_stats_dict[old_class]['Î¦Î¥Î›ÎŸ_Î‘'] -= 1
            for char in ['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']:
                if student_row_old[char] == 'Î':
                    class_stats_dict[old_class][f'{char}_Î'] -= 1

    df_students.at[idx, 'Î¤ÎœÎ—ÎœÎ‘'] = Ï„Î¼Î·Î¼Î±_name
    df_students.at[idx, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±

    Ï„Î¼Î·Î¼Î±Ï„Î±_dict[Ï„Î¼Î·Î¼Î±_name].append(Î¼Î±Î¸Î·Ï„Î·Ï‚_name)

    if Ï„Î¼Î·Î¼Î±_name not in class_stats_dict:
        class_stats_dict[Ï„Î¼Î·Î¼Î±_name] = initialize_class_stats()
    
    student_row = df_students.loc[idx]

    class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['count'] += 1

    characteristics = ['Î¦Î¥Î›ÎŸ', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    for char in characteristics:
        if char == 'Î¦Î¥Î›ÎŸ':
            if student_row[char] == 'Îš':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Îš'] += 1
            elif student_row[char] == 'Î‘':
                class_stats_dict[Ï„Î¼Î·Î¼Î±_name]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
        elif student_row[char] == 'Î':
            class_stats_dict[Ï„Î¼Î·Î¼Î±_name][f'{char}_Î'] += 1

def can_place(df_students, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±_dict, class_stats_dict, max_students_per_class, all_class_names):
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
    if class_stats_dict[target_class_name]['count'] >= max_students_per_class:
        return False, "Î¤Î¿ Ï„Î¼Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î»Î®ÏÎµÏ‚."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ¬Ï‚ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï - Î¼ÏŒÎ½Î¿ Î±Î½ Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ swap
    # (Î±Î½ ÎµÎ¯Î½Î±Î¹ swap, Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î´ÎµÎ½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿Î½ ÏƒÏ…Î½Î¿Î»Î¹ÎºÏŒ Î±ÏÎ¹Î¸Î¼ÏŒ Î¼Î±Î¸Î·Ï„ÏÎ½ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±)
    current_student_class = student_row['Î¤ÎœÎ—ÎœÎ‘']
    if current_student_class != target_class_name: # Only check population balance if not moving within the same class
        hypothetical_counts = {cls: stats['count'] for cls, stats in class_stats_dict.items()}
        
        # Adjust hypothetical counts for the move
        if current_student_class and current_student_class in hypothetical_counts:
            hypothetical_counts[current_student_class] -= 1
        hypothetical_counts[target_class_name] += 1
        
        non_empty_counts = [count for count in hypothetical_counts.values() if count > 0]
        
        if non_empty_counts:
            min_count_non_empty = min(non_empty_counts)
            max_count_non_empty = max(non_empty_counts)
            
            if max_count_non_empty - min_count_non_empty > 1:
                if hypothetical_counts[target_class_name] > min_count_non_empty + 1:
                    return False, "Î— Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¸Î± Ï‡Î±Î»Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (>1)."

    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î³ÎºÏÎ¿ÏÏƒÎµÏ‰Î½ Î¼Îµ Î®Î´Î· Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î± (ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï… Î±Î½ ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÎºÎµÎ¯)
    for placed_student_name in Ï„Î¼Î·Î¼Î±Ï„Î±_dict[target_class_name]:
        if placed_student_name == student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']: # Allow moving within the same class
            continue
        if has_conflict(df_students, student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'], placed_student_name):
            return False, f"Î£ÏÎ³ÎºÏÎ¿Ï…ÏƒÎ· Î¼Îµ Î¼Î±Î¸Î·Ï„Î® '{placed_student_name}' ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î±."
    
    return True, "ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯."


# ----------------------------------------------------
# ÎšÏÏÎ¹Î± Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½
# ----------------------------------------------------

def Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_initial, num_classes_input, max_students_per_class_input):
    df = df_initial.copy()

    if 'Î¤ÎœÎ—ÎœÎ‘' not in df.columns:
        df['Î¤ÎœÎ—ÎœÎ‘'] = None
    if 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£' not in df.columns:
        df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = False

    num_students = len(df)
    
    min_required_classes = math.ceil(num_students / max_students_per_class_input)
    if num_classes_input < min_required_classes:
        st.error(f"ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ ({num_classes_input}) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒÏ‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ {num_students} Î¼Î±Î¸Î·Ï„Î­Ï‚. Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ {min_required_classes} Ï„Î¼Î®Î¼Î±Ï„Î± Î¼Îµ Î¼Î­Î³Î¹ÏƒÏ„Î¿ {max_students_per_class_input} Î¼Î±Î¸Î·Ï„Î­Ï‚ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±.")
        return None

    Ï„Î¼Î·Î¼Î±Ï„Î± = {f'Î¤Î¼Î®Î¼Î± {i+1}': [] for i in range(num_classes_input)}
    class_stats = {f'Î¤Î¼Î®Î¼Î± {i+1}': initialize_class_stats() for i in range(num_classes_input)}
    all_class_names = list(Ï„Î¼Î·Î¼Î±Ï„Î±.keys())
    
    st.write("ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Ï€ÏÎ¿Î·Î³Î¼Î­Î½Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î®...")

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Î· ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±.
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)

    # ----- Î’Î®Î¼Î± 2: Î Î±Î¹Î´Î¹Î¬ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 2: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½")
    teacher_children_to_place = unlocked_students_df[unlocked_students_df['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in teacher_children_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
        
        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        if not placed_in_step:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î Î±Î¹Î´Î¯ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
            
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 3: Î–Ï‰Î·ÏÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚ -----
    st.subheader("Î’Î®Î¼Î± 3: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½")
    lively_students_to_place = unlocked_students_df[unlocked_students_df['Î–Î©Î—Î¡ÎŸÎ£'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in lively_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        min_lively_count = float('inf')
        best_class_for_lively = None

        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            
            if is_valid:
                lively_count_in_class = class_stats[target_class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                if lively_count_in_class < min_lively_count:
                    min_lively_count = lively_count_in_class
                    best_class_for_lively = target_class_name
            current_class_idx = (current_class_idx + 1) % num_classes_input
        
        if best_class_for_lively:
            Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_lively, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
            st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {best_class_for_lively}.")
            placed_in_step = True
        else:
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î–Ï‰Î·ÏÏŒÏ‚) ÏƒÏ„Î¿ {class_name} (Î‘Î½Î±Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÏŒ).")
                    placed_in_step = True
                    break
        
        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 4: Î Î±Î¹Î´Î¹Î¬ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ -----
    st.subheader("Î’Î®Î¼Î± 4: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î Î±Î¹Î´Î¹ÏÎ½ Î¼Îµ Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚")
    special_needs_students_to_place = unlocked_students_df[unlocked_students_df['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘'] == 'Î'].copy()
    
    current_class_idx = 0
    for idx, student_row in special_needs_students_to_place.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        # Î ÏÏÏ„Î· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: ÎˆÎ½Î±Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î¼Îµ Î¹Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± Î±Î½Î¬ Ï„Î¼Î®Î¼Î±
        for _ in range(num_classes_input):
            target_class_name = all_class_names[current_class_idx]
            
            if class_stats[target_class_name]['Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘_Î'] == 0:
                is_valid, msg = can_place(df, student_row, target_class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, target_class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÏ„Î¿ {target_class_name}.")
                    placed_in_step = True
                    break
            current_class_idx = (current_class_idx + 1) % num_classes_input

        # Î”ÎµÏÏ„ÎµÏÎ· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹, Î¿Î¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½:
        if not placed_in_step:
            min_lively_in_class = float('inf') # Î“Î¹Î± Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï„Î¼Î®Î¼Î± Î¼Îµ Ï„Î¿Ï…Ï‚ Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î¶Ï‰Î·ÏÎ¿ÏÏ‚
            best_class_for_special = None
            
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    current_lively_in_class = class_stats[class_name]['Î–Î©Î—Î¡ÎŸÎ£_Î']
                    if current_lively_in_class < min_lively_in_class:
                        min_lively_in_class = current_lively_in_class
                        best_class_for_special = class_name
            
            if best_class_for_special:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, best_class_for_special, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î± - Î•Ï€Î¹Ï€Î»Î­Î¿Î½) ÏƒÏ„Î¿ {best_class_for_special}.")
                placed_in_step = True
            else:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î™Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„Î±) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")

        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 5: Î¦Î¯Î»Î¿Î¹ Î Î±Î¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ -----
    st.subheader("Î’Î®Î¼Î± 5: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¯Î»Ï‰Î½ Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Ï‰Î½ Î Î±Î¹Î´Î¹ÏÎ½")

    locked_students_names = df[df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == True]['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].tolist()

    made_placement = True
    while made_placement:
        made_placement = False
        unlocked_students_to_check = df[(df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] == False)].copy().sample(frac=1, random_state=42)
        
        for idx, student_row in unlocked_students_to_check.iterrows():
            student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
            
            if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
                continue

            friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
            friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]

            for friend_name in friends_list:
                if friend_name in locked_students_names:
                    if is_mutual_friend(df, student_name, friend_name):
                        friend_class = df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name, 'Î¤ÎœÎ—ÎœÎ‘'].iloc[0]
                        
                        if friend_class is not None:
                            is_valid, msg = can_place(df, student_row, friend_class, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                            if is_valid:
                                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, friend_class, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' Î¼Îµ Ï„Î¿Î½/Ï„Î·Î½ Ï†Î¯Î»Î¿/Î· '{friend_name}' ÏƒÏ„Î¿ {friend_class}.")
                                df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                                locked_students_names.append(student_name)
                                made_placement = True
                                break
            if made_placement:
                break 
    
    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 6: Î¦Î¹Î»Î¹ÎºÎ­Ï‚ ÎŸÎ¼Î¬Î´ÎµÏ‚ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ -----
    st.subheader("Î’Î®Î¼Î± 6: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¦Î¹Î»Î¹ÎºÏÎ½ ÎŸÎ¼Î¬Î´Ï‰Î½ Î±Î½Î¬ Î“Î½ÏÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÏÎ½ / Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±")
    
    greek_knowledge_students = unlocked_students_df[unlocked_students_df['ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î'] == 'Î'].copy()
    satisfactory_ability_students = unlocked_students_df[unlocked_students_df['Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤'] == 'Î'].copy()

    students_for_step_6 = pd.concat([
        greek_knowledge_students, 
        satisfactory_ability_students[~satisfactory_ability_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'].isin(greek_knowledge_students['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'])]
    ]).sample(frac=1, random_state=42).reset_index(drop=True)

    for idx, student_row in students_for_step_6.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        friends_list_str = str(student_row['Î¦Î™Î›Î™Î‘']) if pd.notna(student_row['Î¦Î™Î›Î™Î‘']) else ""
        friends_list = [f.strip() for f in friends_list_str.split(",") if f.strip()]
        
        mutual_unlocked_friends = []
        for friend_name in friends_list:
            friend_exists = df[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == friend_name]
            if not friend_exists.empty and friend_exists['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0] == False:
                if is_mutual_friend(df, student_name, friend_name):
                    mutual_unlocked_friends.append(friend_name)
        
        group_to_place = [student_name] + mutual_unlocked_friends
        
        random.shuffle(all_class_names)
        for class_name in all_class_names:
            can_place_group = True
            temp_df = df.copy()
            temp_Ï„Î¼Î·Î¼Î±Ï„Î± = {k: v[:] for k, v in Ï„Î¼Î·Î¼Î±Ï„Î±.items()}
            temp_class_stats = {k: v.copy() for k, v in class_stats.items()}
            
            for member_name in group_to_place:
                member_row = temp_df.loc[temp_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == member_name].iloc[0]
                is_valid, msg = can_place(temp_df, member_row, class_name, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, max_students_per_class_input, all_class_names)
                if not is_valid:
                    can_place_group = False
                    break
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(temp_df, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, member_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=False)

            if can_place_group:
                for member_name in group_to_place:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, member_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{member_name}' (ÎŸÎ¼Î¬Î´Î±) ÏƒÏ„Î¿ {class_name}.")
                    df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == member_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                placed_in_step = True
                break

        if not placed_in_step:
            random.shuffle(all_class_names)
            for class_name in all_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                    st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (ÎœÏŒÎ½Î¿Ï‚) ÏƒÏ„Î¿ {class_name}.")
                    df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True
                    placed_in_step = True
                    break
            if not placed_in_step:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Î¿Î¼Î¬Î´Î±/Î¼ÏŒÎ½Î¿Ï‚) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")


    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 7: Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚ Î§Ï‰ÏÎ¯Ï‚ Î¦Î¹Î»Î¯ÎµÏ‚ -----
    st.subheader("Î’Î®Î¼Î± 7: Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Ï‰Î½ ÎœÎ±Î¸Î·Ï„ÏÎ½")

    for idx, student_row in unlocked_students_df.iterrows():
        student_name = student_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']

        if df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'].iloc[0]:
            continue

        placed_in_step = False
        
        shuffled_class_names = all_class_names[:]
        random.shuffle(shuffled_class_names)

        best_class = None
        min_students = min(class_stats[cls]['count'] for cls in all_class_names)
        
        potential_classes = [cls for cls in shuffled_class_names if class_stats[cls]['count'] == min_students]
        
        for class_name in potential_classes:
            is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
            if is_valid:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, class_name, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚) ÏƒÏ„Î¿ {class_name} (Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Î Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï).")
                placed_in_step = True
                break
        
        if not placed_in_step:
            gender_target_class = None
            min_gender_diff = float('inf')

            for class_name in shuffled_class_names:
                is_valid, msg = can_place(df, student_row, class_name, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, max_students_per_class_input, all_class_names)
                if is_valid:
                    temp_male_count = class_stats[class_name]['Î¦Î¥Î›ÎŸ_Î‘']
                    temp_female_count = class_stats[class_name]['Î¦Î¥Î›ÎŸ_Îš']
                    
                    if student_row['Î¦Î¥Î›ÎŸ'] == 'Î‘':
                        temp_male_count += 1
                    else:
                        temp_female_count += 1
                    
                    current_gender_diff = abs(temp_male_count - temp_female_count)

                    if current_gender_diff < min_gender_diff:
                        min_gender_diff = current_gender_diff
                        gender_target_class = class_name
            
            if gender_target_class:
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student_name, gender_target_class, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=True)
                st.info(f"Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎµ Î¿/Î· Î¼Î±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î± '{student_name}' (Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚) ÏƒÏ„Î¿ {gender_target_class} (Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Î¦ÏÎ»Î¿Ï…).")
                placed_in_step = True
            else:
                st.warning(f"Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Ï„Î¿Ï…/Ï„Î·Ï‚ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±Ï‚ '{student_name}' (Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï‚) ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Ï„Î¼Î®Î¼Î±.")

        if placed_in_step:
            df.loc[df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == student_name, 'ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'] = True

    unlocked_students_df = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=42).reset_index(drop=True)


    # ----- Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚ -----
    st.subheader("Î’Î®Î¼Î± 8: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î Î¿Î¹Î¿Ï„Î¹ÎºÏÎ½ Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ & Î”Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚")

    # Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ Ï€ÏÎ¿Ï‚ ÎµÎ¾Î¹ÏƒÎ¿ÏÏÏŒÏ€Î·ÏƒÎ· (ÎµÎºÏ„ÏŒÏ‚ Ï†ÏÎ»Î¿Ï…, Ï€Î¿Ï… Î±Î½Ï„Î¹Î¼ÎµÏ„Ï‰Ï€Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ Î’Î®Î¼Î± 7)
    qualitative_characteristics = ['Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    
    # Î•Ï€Î±Î½Î±Î»Î±Î¼Î²Î±Î½ÏŒÎ¼ÎµÎ½Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î³Î¹Î± Î²ÎµÎ»Ï„Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·
    max_iterations = 5 # Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± Î½Î± Î¼Î·Î½ Ï„ÏÎ­Ï‡ÎµÎ¹ ÎµÏ€' Î±ÏŒÏÎ¹ÏƒÏ„Î¿Î½
    
    for iteration in range(max_iterations):
        st.write(f"Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·Ï‚: {iteration + 1}/{max_iterations}")
        made_swap = False
        
        # Î‘Î½Î±ÎºÎ±Ï„Î­ÏˆÏ„Îµ Ï„Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚ Ï€Î¿Ï… Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿Î¹ Î±Ï…ÏƒÏ„Î·ÏÎ¬
        # (Î´Î·Î»Î±Î´Î®, Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î¼ÎµÏ„Î±ÎºÎ¹Î½Î·Î¸Î¿ÏÎ½ Î±Î½ Î²Î¿Î·Î¸Î¬ÎµÎ¹ ÏƒÏ„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±)
        movable_students = df[~df['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£']].copy().sample(frac=1, random_state=random.randint(0, 1000)).reset_index()

        for idx1, student1_row in movable_students.iterrows():
            student1_name = student1_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
            class1 = student1_row['Î¤ÎœÎ—ÎœÎ‘']
            
            if class1 is None: # Should not happen if all placed in previous steps
                continue
            
            for idx2, student2_row in movable_students.iterrows():
                if idx1 == idx2:
                    continue # Î”ÎµÎ½ ÏƒÏ…Î³ÎºÏÎ¯Î½Î¿Ï…Î¼Îµ Ï„Î¿Î½ Î¯Î´Î¹Î¿ Î¼Î±Î¸Î·Ï„Î®
                
                student2_name = student2_row['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']
                class2 = student2_row['Î¤ÎœÎ—ÎœÎ‘']

                if class2 is None or class1 == class2: # Î”ÎµÎ½ ÏƒÏ…Î³ÎºÏÎ¯Î½Î¿Ï…Î¼Îµ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ Ï„Î¼Î®Î¼Î±
                    continue

                # Î¥Ï€Î¿Î¸ÎµÏ„Î¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½Ï„Î±Î»Î»Î±Î³Î®Ï‚
                temp_df = df.copy()
                temp_Ï„Î¼Î·Î¼Î±Ï„Î± = {k: v[:] for k, v in Ï„Î¼Î·Î¼Î±Ï„Î±.items()}
                temp_class_stats = {k: v.copy() for k, v in class_stats.items()}

                # Î ÏÎ¿ÏƒÎ¿Î¼Î¿Î¯Ï‰ÏƒÎ· Î±Ï†Î±Î¯ÏÎµÏƒÎ·Ï‚ student1 Î±Ï€ÏŒ class1 ÎºÎ±Î¹ student2 Î±Ï€ÏŒ class2
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(temp_df, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, student1_name, None, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=False) # Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® "Î±Ï†Î±Î¯ÏÎµÏƒÎ·"
                Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(temp_df, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats, student2_name, None, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=False) # Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® "Î±Ï†Î±Î¯ÏÎµÏƒÎ·"
                
                # Î•Ï€Î±Î½Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î­Ï‚ Î³Î¹Î± Ï„Î¿ can_place
                temp_class_stats_after_removal = {cls: initialize_class_stats() for cls in all_class_names}
                for s_name in temp_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ']:
                    s_class = temp_df.loc[temp_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == s_name, 'Î¤ÎœÎ—ÎœÎ‘'].iloc[0]
                    if s_class:
                        temp_student_row = temp_df.loc[temp_df['ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ'] == s_name].iloc[0]
                        # Manually update stats for remaining students, as Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· does this for the added student.
                        # This part needs to be careful to not double-count if a student moves to None.
                        if s_name not in [student1_name, student2_name]:
                             if s_class not in temp_class_stats_after_removal:
                                 temp_class_stats_after_removal[s_class] = initialize_class_stats()
                             
                             temp_class_stats_after_removal[s_class]['count'] += 1
                             if temp_student_row['Î¦Î¥Î›ÎŸ'] == 'Îš':
                                 temp_class_stats_after_removal[s_class]['Î¦Î¥Î›ÎŸ_Îš'] += 1
                             elif temp_student_row['Î¦Î¥Î›ÎŸ'] == 'Î‘':
                                 temp_class_stats_after_removal[s_class]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
                             for char in qualitative_characteristics:
                                 if temp_student_row[char] == 'Î':
                                     temp_class_stats_after_removal[s_class][f'{char}_Î'] += 1

                # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯ Î¿ student1 Î½Î± Ï€Î¬ÎµÎ¹ ÏƒÏ„Î¿ class2 ÎºÎ±Î¹ Î¿ student2 ÏƒÏ„Î¿ class1
                can_s1_to_c2, msg1 = can_place(temp_df, student1_row, class2, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats_after_removal, max_students_per_class_input, all_class_names)
                can_s2_to_c1, msg2 = can_place(temp_df, student2_row, class1, temp_Ï„Î¼Î·Î¼Î±Ï„Î±, temp_class_stats_after_removal, max_students_per_class_input, all_class_names)
                
                if can_s1_to_c2 and can_s2_to_c1:
                    # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î· Î±Î½Ï„Î±Î»Î»Î±Î³Î® Î²ÎµÎ»Ï„Î¹ÏÎ½ÎµÎ¹ Ï„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±
                    
                    # Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Î·Ï‚ Î±ÏÏ‡Î¹ÎºÎ®Ï‚ Î±Î½Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±Ï‚
                    initial_imbalance = 0
                    for char in qualitative_characteristics:
                        initial_imbalance += abs(class_stats[class1][f'{char}_Î'] - class_stats[class2][f'{char}_Î'])
                    initial_imbalance += abs(class_stats[class1]['Î¦Î¥Î›ÎŸ_Îš'] - class_stats[class2]['Î¦Î¥Î›ÎŸ_Îš'])
                    initial_imbalance += abs(class_stats[class1]['Î¦Î¥Î›ÎŸ_Î‘'] - class_stats[class2]['Î¦Î¥Î›ÎŸ_Î‘'])

                    # Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î¿Î¸ÎµÏ„Î¹ÎºÏÎ½ Î½Î­Ï‰Î½ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½
                    hypo_stats = {k: v.copy() for k, v in class_stats.items()}
                    
                    # Remove student1 from class1's stats
                    hypo_stats[class1]['count'] -= 1
                    if student1_row['Î¦Î¥Î›ÎŸ'] == 'Îš': hypo_stats[class1]['Î¦Î¥Î›ÎŸ_Îš'] -= 1
                    else: hypo_stats[class1]['Î¦Î¥Î›ÎŸ_Î‘'] -= 1
                    for char in qualitative_characteristics:
                        if student1_row[char] == 'Î': hypo_stats[class1][f'{char}_Î'] -= 1
                    
                    # Add student2 to class1's stats
                    hypo_stats[class1]['count'] += 1
                    if student2_row['Î¦Î¥Î›ÎŸ'] == 'Îš': hypo_stats[class1]['Î¦Î¥Î›ÎŸ_Îš'] += 1
                    else: hypo_stats[class1]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
                    for char in qualitative_characteristics:
                        if student2_row[char] == 'Î': hypo_stats[class1][f'{char}_Î'] += 1

                    # Remove student2 from class2's stats
                    hypo_stats[class2]['count'] -= 1
                    if student2_row['Î¦Î¥Î›ÎŸ'] == 'Îš': hypo_stats[class2]['Î¦Î¥Î›ÎŸ_Îš'] -= 1
                    else: hypo_stats[class2]['Î¦Î¥Î›ÎŸ_Î‘'] -= 1
                    for char in qualitative_characteristics:
                        if student2_row[char] == 'Î': hypo_stats[class2][f'{char}_Î'] -= 1

                    # Add student1 to class2's stats
                    hypo_stats[class2]['count'] += 1
                    if student1_row['Î¦Î¥Î›ÎŸ'] == 'Îš': hypo_stats[class2]['Î¦Î¥Î›ÎŸ_Îš'] += 1
                    else: hypo_stats[class2]['Î¦Î¥Î›ÎŸ_Î‘'] += 1
                    for char in qualitative_characteristics:
                        if student1_row[char] == 'Î': hypo_stats[class2][f'{char}_Î'] += 1

                    # Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Î·Ï‚ Î½Î­Î±Ï‚ Î±Î½Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±Ï‚
                    new_imbalance = 0
                    for char in qualitative_characteristics:
                        new_imbalance += abs(hypo_stats[class1][f'{char}_Î'] - hypo_stats[class2][f'{char}_Î'])
                    new_imbalance += abs(hypo_stats[class1]['Î¦Î¥Î›ÎŸ_Îš'] - hypo_stats[class2]['Î¦Î¥Î›ÎŸ_Îš'])
                    new_imbalance += abs(hypo_stats[class1]['Î¦Î¥Î›ÎŸ_Î‘'] - hypo_stats[class2]['Î¦Î¥Î›ÎŸ_Î‘'])

                    if new_imbalance < initial_imbalance:
                        # Î•ÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î·Ï‚ Î±Î½Ï„Î±Î»Î»Î±Î³Î®Ï‚
                        Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student1_name, class2, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=student1_row['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'])
                        Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·(df, Ï„Î¼Î·Î¼Î±Ï„Î±, class_stats, student2_name, class1, ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î±=student2_row['ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎŸÎ£'])
                        st.info(f"Î‘Î½Ï„Î±Î»Î»Î¬Ï‡Î¸Î·ÎºÎ±Î½ Î¿Î¹ Î¼Î±Î¸Î·Ï„Î­Ï‚ '{student1_name}' ÎºÎ±Î¹ '{student2_name}' Î³Î¹Î± Î²ÎµÎ»Ï„Î¯Ï‰ÏƒÎ· Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±Ï‚. ({class1} <-> {class2})")
                        made_swap = True
                        break # ÎÎ±Î½Î±Î¾ÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Ï„Î·Î½ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ· Î³Î¹Î± Î½Î± ÎµÏ€Ï‰Ï†ÎµÎ»Î·Î¸ÎµÎ¯Ï„Îµ Î±Ï€ÏŒ Ï„Î· Î½Î­Î± Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±
            if made_swap:
                break
        
        if not made_swap:
            st.info(f"Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ Î²ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹Ï‚ ÏƒÏ„Î·Î½ Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î± Ï„Ï‰Î½ Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ ÏƒÏ„Î·Î½ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ· {iteration + 1}.")
            break # Î”ÎµÎ½ Î­Î³Î¹Î½Î±Î½ Î±Î»Î»Î±Î³Î­Ï‚, Î¿Ï€ÏŒÏ„Îµ ÏƒÏ„Î±Î¼Î±Ï„Î¬Î¼Îµ


    # Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ±Î¹ Î±Î½Î±Ï†Î¿ÏÎ¬ Î³Î¹Î± Ï„Ï…Ï‡ÏŒÎ½ Î±Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·Ï„Î¿Ï…Ï‚ Î¼Î±Î¸Î·Ï„Î­Ï‚
    unplaced_students = df[df['Î¤ÎœÎ—ÎœÎ‘'].isnull()]
    if not unplaced_students.empty:
        st.warning(f"Î ÏÎ¿ÏƒÎ¿Ï‡Î®: {len(unplaced_students)} Î¼Î±Î¸Î·Ï„Î­Ï‚/Ï„ÏÎ¹ÎµÏ‚ Î´ÎµÎ½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ ÏƒÎµ Ï„Î¼Î®Î¼Î±.")
        st.dataframe(unplaced_students)
    else:
        st.success("ÎŒÎ»Î¿Î¹ Î¿Î¹ Î¼Î±Î¸Î·Ï„Î­Ï‚/Ï„ÏÎ¹ÎµÏ‚ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®Î¸Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    return df

# ----------------------------------------------------
# Î›Î¿Î¹Ï€Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ (Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î¯Î´Î¹ÎµÏ‚)
# ----------------------------------------------------

def create_excel_file(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ÎšÎ±Ï„Î±Î½Î¿Î¼Î®')
    return output.getvalue()

def plot_distribution(df, column, title):
    fig, ax = plt.subplots(figsize=(10, 6))
    
    if column == 'Î¦Î¥Î›ÎŸ':
        categories = ['Îš', 'Î‘']
    else:
        categories = ['Î', 'ÎŸ']

    grouped_data = df.groupby(['Î¤ÎœÎ—ÎœÎ‘', column]).size().unstack(fill_value=0)
    
    for cat in categories:
        if cat not in grouped_data.columns:
            grouped_data[cat] = 0

    grouped_data = grouped_data[categories]
    
    grouped_data.plot(kind='bar', stacked=True, ax=ax)
    
    ax.set_title(title)
    ax.set_ylabel('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎœÎ±Î¸Î·Ï„ÏÎ½')
    ax.set_xlabel('Î¤Î¼Î®Î¼Î±')
    plt.xticks(rotation=45, ha='right')
    plt.tight_layout()
    st.pyplot(fig)

# ----------------------------------------------------
# ÎšÏÏÎ¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Streamlit (Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿)
# ----------------------------------------------------

st.sidebar.title("ğŸ” ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚")
password = st.sidebar.text_input("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ:", type="password")
if password != "katanomi2025":
    st.warning("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.")
    st.stop()

enable_app = st.sidebar.checkbox("âœ… Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚", value=True)
if not enable_app:
    st.info("âœ‹ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·.")
    st.stop()

st.title("ğŸ“Š Î¨Î·Ï†Î¹Î±ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±Î¸Î·Ï„ÏÎ½ Î‘' Î”Î·Î¼Î¿Ï„Î¹ÎºÎ¿Ï")

uploaded_file = st.file_uploader("â¬†ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î±Î¸Î·Ï„ÏÎ½", type="xlsx")

df_students = None

if uploaded_file is not None:
    df_students = pd.read_excel(uploaded_file)
    st.success("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")

    st.subheader("Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:")
    st.dataframe(df_students.head())

    st.sidebar.subheader("Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    num_classes_input = st.sidebar.number_input("Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½:", min_value=1, value=3, step=1)
    max_students_per_class_input = st.sidebar.number_input("ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¼Î±Î¸Î·Ï„ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±:", min_value=10, max_value=30, value=25, step=1)

    if st.button("â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÎœÎ±Î¸Î·Ï„ÏÎ½"):
        df_katanomi = Ï€Î»Î®ÏÎ·Ï‚_ÎºÎ±Ï„Î±Î½Î¿Î¼Î®(df_students.copy(), num_classes_input, max_students_per_class_input)
        if df_katanomi is not None:
            st.session_state["df_katanomi"] = df_katanomi
            st.success("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î±Î¸Î·Ï„ÏÎ½!")
        else:
            pass

if "df_katanomi" in st.session_state and st.session_state["df_katanomi"] is not None:
    df_result = st.session_state["df_katanomi"]

    st.subheader("ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    st.dataframe(df_result)

    if st.button("â¬‡ï¸ Î›Î®ÏˆÎ· Excel Î¼Îµ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®"):
        excel_bytes = create_excel_file(df_result)
        st.download_button(
            label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel",
            data=excel_bytes,
            file_name="katanomi.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    
    st.subheader("ğŸ“Š Î Î¯Î½Î±ÎºÎ±Ï‚ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    if 'Î¤ÎœÎ—ÎœÎ‘' in df_result.columns and not df_result['Î¤ÎœÎ—ÎœÎ‘'].isnull().all():
        characteristics_for_stats = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
        
        df_stats = df_result.copy()
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                df_stats[col] = df_stats[col].apply(lambda x: True if x == 'Î' else False)

        female_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Îš'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        male_counts = df_stats[df_stats['Î¦Î¥Î›ÎŸ'] == 'Î‘'].groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)

        stats_table = pd.DataFrame({
            'Î£ÏÎ½Î¿Î»Î¿ ÎœÎ±Î¸Î·Ï„ÏÎ½': df_result.groupby('Î¤ÎœÎ—ÎœÎ‘').size().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0),
            'ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹Î±': female_counts,
            'Î‘Î³ÏŒÏÎ¹Î±': male_counts,
        })
        
        for col in characteristics_for_stats:
            if col != 'Î¦Î¥Î›ÎŸ':
                stats_table[f'{col} (ÎÎ±Î¹)'] = df_stats.groupby('Î¤ÎœÎ—ÎœÎ‘')[col].sum().reindex(df_result['Î¤ÎœÎ—ÎœÎ‘'].unique(), fill_value=0)
        
        st.dataframe(stats_table)
    else:
        st.info("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Î¼Î±Î¸Î·Ï„Î­Ï‚ ÏƒÎµ Ï„Î¼Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î± Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬.")

    st.subheader("ğŸ“ˆ Î¡Î±Î²Î´Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚")
    ÎµÏ€Î¹Î»Î¿Î³Î· = st.radio("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:", ["Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬", "ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"])

    plot_columns = ['Î¦Î¥Î›ÎŸ', 'Î–Î©Î—Î¡ÎŸÎ£', 'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘', 'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î', 'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥', 'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤']
    plot_titles = {
        'Î¦Î¥Î›ÎŸ': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦ÏÎ»Î¿Ï…',
        'Î–Î©Î—Î¡ÎŸÎ£': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î–Ï‰Î·ÏÏÎ½ ÎœÎ±Î¸Î·Ï„ÏÎ½',
        'Î™Î”Î™Î‘Î™Î¤Î•Î¡ÎŸÎ¤Î—Î¤Î‘': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™Î´Î¹Î±Î¹Ï„ÎµÏÎ¿Ï„Î®Ï„Ï‰Î½',
        'ÎšÎ‘Î›Î— Î“ÎÎ©Î£Î— Î•Î›Î›Î—ÎÎ™ÎšÎ©Î': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎšÎ±Î»Î®Ï‚ Î“Î½ÏÏƒÎ·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÏÎ½',
        'Î Î‘Î™Î”Î™ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î±Î¹Î´Î¹ÏÎ½ Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½',
        'Î™ÎšÎ‘ÎÎŸÎ ÎŸÎ™Î—Î¤': 'ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î™ÎºÎ±Î½Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ®Ï‚ ÎœÎ±Î¸Î·ÏƒÎ¹Î±ÎºÎ®Ï‚ Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±Ï‚'
    }

    if ÎµÏ€Î¹Î»Î¿Î³Î· == "Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¬":
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, plot_titles.get(col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}"))
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")
    else:
        for col in plot_columns:
            if col in df_result.columns:
                plot_distribution(df_result, col, f"ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î²Î¬ÏƒÎµÎ¹ {col}")
            else:
                st.warning(f"Î— ÏƒÏ„Î®Î»Î· '{col}' Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±.")

st.markdown("---")
st.markdown(
    """
    ğŸ“Œ **ÎÎ¿Î¼Î¹ÎºÎ® Î”Î®Î»Ï‰ÏƒÎ·**: Î— Ï‡ÏÎ®ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ ÏÎ·Ï„Î® Î³ÏÎ±Ï€Ï„Î® Î¬Î´ÎµÎ¹Î± Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿Ï, Î Î±Î½Î±Î³Î¹ÏÏ„Î±Ï‚ Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï….
    ÎŒÎ»Î± Ï„Î± Ï€Î½ÎµÏ…Î¼Î±Ï„Î¹ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î· Î“Î¹Î±Î½Î½Î¹Ï„ÏƒÎ¿Ï€Î¿ÏÎ»Î¿Ï… Î Î±Î½Î±Î³Î¹ÏÏ„Î±. Î“Î¹Î± Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
    [yiannitsoopanayiota.katanomi@gmail.com](mailto:yiannitsoopanayiota.katanomi@gmail.com)
    """
)